<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode | Apache Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.apache.org/seata.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.apache.org/seata.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.apache.org/seata.github.io/blog/seata-tcc-fence"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode | Apache Seata"><meta data-rh="true" name="description" content="Seata version 1.5.1 from Alibaba has finally resolved the issues of idempotence, dangling, and empty rollback in TCC (Try-Confirm-Cancel) mode. This article mainly explains how Seata addresses these problems."><meta data-rh="true" property="og:description" content="Seata version 1.5.1 from Alibaba has finally resolved the issues of idempotence, dangling, and empty rollback in TCC (Try-Confirm-Cancel) mode. This article mainly explains how Seata addresses these problems."><meta data-rh="true" name="keywords" content="Seata,TCC,idempotence,dangling,empty rollback"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-06-25T00:00:00.000Z"><link data-rh="true" rel="icon" href="/seata.github.io/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.apache.org/seata.github.io/blog/seata-tcc-fence"><link data-rh="true" rel="alternate" href="https://seata.apache.org/seata.github.io/blog/seata-tcc-fence" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.apache.org/seata.github.io/zh-cn/blog/seata-tcc-fence" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.apache.org/seata.github.io/blog/seata-tcc-fence" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/seata.github.io/blog/rss.xml" title="Apache Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/seata.github.io/blog/atom.xml" title="Apache Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata" href="/seata.github.io/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata">
<script src="https://www.googletagmanager.com/gtag/js?id=G-X4LJGF90X2" async></script><link rel="stylesheet" href="/seata.github.io/assets/css/styles.5eb339aa.css">
<link rel="preload" href="/seata.github.io/assets/js/runtime~main.c3f2affa.js" as="script">
<link rel="preload" href="/seata.github.io/assets/js/main.36bade35.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="https://hm.baidu.com/hm.js?104e73ef0c18b416b27abb23757ed8ee"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/seata.github.io/"><div class="navbar__logo"><img src="/seata.github.io/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/seata.github.io/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/seata.github.io/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/seata.github.io/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/seata.github.io/docs/next/overview/what-is-seata">Next Version</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/seata.github.io/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/seata.github.io/docs/developers/contributor-guide/new-contributor-guide_dev">Developers</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/seata.github.io/blog">Blog</a><a class="navbar__item navbar__link" href="/seata.github.io/users">Users</a><a class="navbar__item navbar__link" href="/seata.github.io/community">Community</a><a class="navbar__item navbar__link" href="/seata.github.io/unversioned/download/seata-server">Download</a><a class="navbar__item navbar__link" href="/seata.github.io/solution">Solution</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Demos</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_blank" href="/seata.github.io/saga-designer">Saga Designer</a></li><li><a class="dropdown__link" target="_blank" href="/seata.github.io/saga-designer-legacy">Saga Designer (Legacy)</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/seata.github.io/blog/seata-tcc-fence" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/seata.github.io/zh-cn/blog/seata-tcc-fence" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">ä¸­</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/integrate-seata-with-spring-cloud">integrate-seata-with-spring-cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/iscas2023">iscas2023</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-1.5.2">seata-1.5.2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-1.6.0">seata-1.6.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-config-modular">seata-analysis-config-modular</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-core-modular">seata-analysis-core-modular</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-dubbo-transmit-xid">seata-analysis-dubbo-transmit-xid</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-go-server">seata-analysis-go-server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-java-client">seata-analysis-java-client</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-java-server">seata-analysis-java-server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-simple">seata-analysis-simple</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-tcc-modular">seata-analysis-tcc-modular</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-at-demo-in-mac">seata-at-demo-in-mac</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-at-lock">seata-at-lock</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-at-mode-design">seata-at-mode-design</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-at-mode-start-rm-tm">seata-at-mode-start-rm-tm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-at-mode-start">seata-at-mode-start</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-at-tcc-saga">seata-at-tcc-saga</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-client-start-analysis-01">seata-client-start-analysis-01</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-client-start-analysis-02">seata-client-start-analysis-02</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-community-meetup-hangzhou-ready">seata-community-meetup-hangzhou-ready</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-config-center">seata-config-center</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-config-manager">seata-config-manager</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-datasource-proxy">seata-datasource-proxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-dsproxy-deadlock">seata-dsproxy-deadlock</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-dynamic-config-and-dynamic-disable">seata-dynamic-config-and-dynamic-disable</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-go-1.2.0">seata-go-1.2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-golang-communication-mode">seata-golang-communication-mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-ha-practice">seata-ha-practice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-meetup-hangzhou">seata-meetup-hangzhou</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-mybatisplus-analysis">seata-mybatisplus-analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-nacos-analysis">seata-nacos-analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-nacos-docker">seata-nacos-docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-observable-practice">seata-observable-practice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-quick-start">seata-quick-start</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-raft-detailed-explanation">seata-raft-detailed-explanation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-rpc-refactor">seata-rpc-refactor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-sourcecode-client-bootstrap">seata-sourcecode-client-bootstrap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-sourcecode-server-bootstrap">seata-sourcecode-server-bootstrap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-spring-boot-aop-aspectj">seata-spring-boot-aop-aspectj</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-tcc">seata-tcc</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-xa-introduce">seata-xa-introduce</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/springboot-dubbo-mybatisplus-seata">springboot-dubbo-mybatisplus-seata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/tcc-mode-applicable-scenario-analysis">tcc-mode-applicable-scenario-analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/tcc-mode-design-principle">tcc-mode-design-principle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/explore-seata-journey">Exploring the Journey of Open Source Development in Seata Project</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-connect-data-and-application">Seata:Bridging Data and Applications</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/seata.github.io/blog/seata-tcc-fence">Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-snowflake-explain">Q&amp;A on the New Version of Snowflake Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-analysis-UUID-generator">Analysis of Seata&#x27;s Distributed UUID Generator Based on Improved Snowflake Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/seata-feature-undo-log-compress">Seata New Feature Support -- Undo_Log Compression</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/integrate-seata-tcc-mode-with-spring-cloud">Integration of Spring Cloud with Seata for Distributed Transaction - TCC Mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/design-more-flexable-application-by-saga">Designing More Flexible Financial Applications with Seata Saga</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/how-to-support-spring-cloud">Fescar Integration with Spring Cloud In-Depth Analysis of Source Code</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/quick-start-use-seata-and-dubbo-services">How to use Seata to ensure consistency between Dubbo Microservices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/seata.github.io/blog/manual-transaction-mode">MT mode</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-06-25T00:00:00.000Z" itemprop="datePublished">June 25, 2022</time> Â· <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Zhu Jinjun</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Today, let&#x27;s talk about how the new version (1.5.1) of Alibaba&#x27;s Seata resolves the issues of idempotence, dangling, and empty rollback in TCC mode.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-tcc">1 TCC<a href="#1-tcc" class="hash-link" aria-label="Direct link to 1 TCC" title="Direct link to 1 TCC">â</a></h2><p>TCC mode is the most classic solution for distributed transactions. It divides the distributed transaction into two phases. In the try phase, resources are reserved for each branch transaction. If all branch transactions successfully reserve resources, the global transaction proceeds to the commit phase for committing the transaction globally. However, if any node fails to reserve resources, the global transaction enters the cancel phase to rollback the transaction globally.</p><p>Taking traditional order, inventory, and account services as an example, in the try phase, resources are attempted to be reserved by inserting orders, deducting inventory, and deducting amounts. These three services require local transaction commits, and the resources can be transferred to an intermediate table. In the commit phase, the resources reserved in the try phase are transferred to the final table. In the cancel phase, the resources reserved in the try phase are released, such as returning the account amount to the customer&#x27;s account.</p><p><strong>Note: The try phase must involve committing local transactions. For example, when deducting the order amount, the money must be deducted from the customer&#x27;s account. If it is not deducted, there will be a problem in the commit phase if the customer&#x27;s account does not have enough money.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-try-commit">1.1 try-commit<a href="#11-try-commit" class="hash-link" aria-label="Direct link to 1.1 try-commit" title="Direct link to 1.1 try-commit">â</a></h3><p>In the try phase, resources are first reserved, and then they are deducted in the commit phase. The diagram below illustrates this process:</p><p><img loading="lazy" alt="fence-try-commit" src="/seata.github.io/assets/images/fence-try-commit-453b9a1e280200057448436ecd7eef27.png" width="501" height="681" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-try-cancel">1.2 try-cancel<a href="#12-try-cancel" class="hash-link" aria-label="Direct link to 1.2 try-cancel" title="Direct link to 1.2 try-cancel">â</a></h3><p>In the try phase, resources are first reserved. If the deduction of inventory fails, leading to a rollback of the global transaction, the resources are released in the cancel phase. The diagram below illustrates this process:</p><p><img loading="lazy" alt="fence-try-cancel" src="/seata.github.io/assets/images/fence-try-cancel-eafbbb62134fe4e3ed61bdc2a47461b9.png" width="501" height="681" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-tcc-advantages">2 TCC Advantages<a href="#2-tcc-advantages" class="hash-link" aria-label="Direct link to 2 TCC Advantages" title="Direct link to 2 TCC Advantages">â</a></h2><p>The biggest advantage of TCC mode is its high efficiency. In the try phase, the resource locking in TCC mode is not a true lock, but rather a real local transaction submission that reserves resources in an intermediate state without the need for blocking and waiting. Therefore, it is more efficient than other modes.</p><p>Additionally, the TCC mode can be optimized as follows:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-asynchronous-commit">2.1 Asynchronous Commit<a href="#21-asynchronous-commit" class="hash-link" aria-label="Direct link to 2.1 Asynchronous Commit" title="Direct link to 2.1 Asynchronous Commit">â</a></h3><p>After the try phase succeeds, instead of immediately entering the confirm/cancel phase, it is considered that the global transaction has already ended. A scheduled task is started to asynchronously execute the confirm/cancel phase, which involves deducting or releasing resources. This approach can greatly improve performance.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-same-database-mode">2.2 Same-Database Mode<a href="#22-same-database-mode" class="hash-link" aria-label="Direct link to 2.2 Same-Database Mode" title="Direct link to 2.2 Same-Database Mode">â</a></h3><p>In the TCC mode, there are three roles:</p><ul><li>TM: Manages the global transaction, including starting the global transaction and committing/rolling back the global transaction.</li><li>RM: Manages the branch transaction.</li><li>TC: Manages the state of the global transaction and branch transactions.</li></ul><p>The diagram below is from the Seata official website:</p><p><img loading="lazy" alt="fence-fiffrent-db" src="/seata.github.io/assets/images/fence-fiffrent-db-1f7a834639aa755d73fa2af435c4f042.png" width="853" height="482" class="img_ev3q"></p><p>When TM starts a global transaction, RM needs to send a registration message to TC, and TC saves the state of the branch transaction. When TM requests a commit or rollback, TC needs to send commit or rollback messages to RM. In this way, in a distributed transaction with two branch transactions, there are four RPCs between TC and RM.</p><p>After optimization, the process is as shown in the diagram below:</p><p>TC saves the state of the global transaction. When TM starts a global transaction, RM no longer needs to send a registration message to TC. Instead, it saves the state of the branch transaction locally. After TM sends a commit or rollback message to TC, the asynchronous thread in RM first retrieves the uncommitted branch transactions saved locally, and then sends a message to TC to obtain the state of the global transaction in which the local branch transaction is located, in order to determine whether to commit or rollback the local transaction.</p><p>With this optimization, the number of RPCs is reduced by 50%, resulting in a significant performance improvement.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-rm-code-example">3 RM Code Example<a href="#3-rm-code-example" class="hash-link" aria-label="Direct link to 3 RM Code Example" title="Direct link to 3 RM Code Example">â</a></h2><p>Taking the inventory service as an example, the RM inventory service interface code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@LocalTCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * decrease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param xid </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param productId </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param count </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = &quot;storageApi&quot;, commitMethod = &quot;commit&quot;, rollbackMethod = &quot;rollback&quot;, useTCCFence = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean decrease(String xid, Long productId, Integer count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By using the <code>@LocalTCC</code> annotation, when the RM is initialized, it registers a branch transaction with the TC. The <code>try</code> phase method (e.g., <code>decrease</code> method) is annotated with <code>@TwoPhaseBusinessAction</code>, which defines the branch transaction&#x27;s <code>resourceId</code>, <code>commit</code> method, <code>cancel</code> method, and the <code>useTCCFence</code> property, which will be explained in the next section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-issues-with-tcc">4 Issues with TCC<a href="#4-issues-with-tcc" class="hash-link" aria-label="Direct link to 4 Issues with TCC" title="Direct link to 4 Issues with TCC">â</a></h2><p>There are three major issues with the TCC pattern: idempotence, suspension, and empty rollback. In version 1.5.1 of Seata, a transaction control table named <code>tcc_fence_log</code> is introduced to address these issues. The <code>useTCCFence</code> property mentioned in the previous <code>@TwoPhaseBusinessAction</code> annotation is used to enable or disable this mechanism, with a default value of <code>false</code>.</p><p>The creation SQL statement for the <code>tcc_fence_log</code> table (in MySQL syntax) is as follows:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `tcc_fence_log`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`           VARCHAR(128)  NOT NULL COMMENT &#x27;global id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`     BIGINT        NOT NULL COMMENT &#x27;branch id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `action_name`   VARCHAR(64)   NOT NULL COMMENT &#x27;action name&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`        TINYINT       NOT NULL COMMENT &#x27;status(tried:1;committed:2;rollbacked:3;suspended:4)&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`    DATETIME(3)   NOT NULL COMMENT &#x27;create time&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`  DATETIME(3)   NOT NULL COMMENT &#x27;update time&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`xid`, `branch_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_gmt_modified` (`gmt_modified`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_status` (`status`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEFAULT CHARSET = utf8mb4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-idempotence">4.1 Idempotence<a href="#41-idempotence" class="hash-link" aria-label="Direct link to 4.1 Idempotence" title="Direct link to 4.1 Idempotence">â</a></h3><p>During the commit/cancel phase, if the TC does not receive a response from the branch transaction, it needs to retry the operation. Therefore, it is necessary for the branch transaction to support idempotence.</p><p>Let&#x27;s take a look at how this is addressed in the new version. The following code is from the <code>TCCResourceManager</code> class:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource = (TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object targetTCCBean = tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method commitMethod = tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BusinessActionContext businessActionContext = getBusinessActionContext(xid, branchId, resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] args = this.getTwoPhaseCommitArgs(tccResource, businessActionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //whether the useTCCFence property is set to true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(businessActionContext.getActionContext(Constants.USE_TCC_FENCE))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = TCCFenceHandler.commitFence(commitMethod, targetTCCBean, xid, branchId, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (SkipCallbackWrapperException | UndeclaredThrowableException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e.getCause();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;TCC resource commit result : {}, xid: {}, branchId: {}, resourceId: {}&quot;, result, xid, branchId, resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result ? BranchStatus.PhaseTwo_Committed : BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above code shows that when executing the commit method of the branch transaction, it first checks if the <code>useTCCFence</code> property is <code>true</code>. If it is <code>true</code>, it follows the <code>commitFence</code> logic in the <code>TCCFenceHandler</code> class; otherwise, it follows the normal commit logic.</p><p>The <code>commitFence</code> method in the <code>TCCFenceHandler</code> class calls the <code>commitFence</code> method of the same class. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean commitFence(Method commitMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  String xid, Long branchId, Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TCCFenceException(String.format(&quot;TCC fence record not exists, commit fence method failed. xid= %s, branchId= %s&quot;, xid, branchId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FrameworkErrorCode.RecordAlreadyExists);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (TCCFenceConstant.STATUS_COMMITTED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info(&quot;Branch transaction has already committed before. idempotency rejected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (TCCFenceConstant.STATUS_ROLLBACKED == tccFenceDO.getStatus() || TCCFenceConstant.STATUS_SUSPENDED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isWarnEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn(&quot;Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, commitMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_COMMITTED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From the code, we can see that when committing the transaction, it first checks if there is a record in the <code>tcc_fence_log</code> table. If a record exists, it checks the transaction execution status and returns. This ensures idempotence by avoiding duplicate commits if the transaction status is already <code>STATUS_COMMITTED</code>. If there is no record in the <code>tcc_fence_log</code> table, a new record is inserted for later retry detection.</p><p>The rollback logic is similar to the commit logic and is implemented in the <code>rollbackFence</code> method of the <code>TCCFenceHandler</code> class.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-empty-rollback">4.2 Empty Rollback<a href="#42-empty-rollback" class="hash-link" aria-label="Direct link to 4.2 Empty Rollback" title="Direct link to 4.2 Empty Rollback">â</a></h3><p>In the scenario shown in the following diagram, the account service consists of a cluster of two nodes. During the try phase, the account service on Node 1 encounters a failure. Without considering retries, the global transaction must reach the end state, requiring a cancel operation to be performed on the account service.</p><p><img loading="lazy" alt="fence-empty-rollback" src="/seata.github.io/assets/images/fence-empty-rollback-55e0c44f8e67d5df91c0f930860baa1f.png" width="591" height="681" class="img_ev3q"></p><p>Seata&#x27;s solution is to insert a record into the <code>tcc_fence_log</code> table during the try phase, with the <code>status</code> field set to <code>STATUS_TRIED</code>. During the rollback phase, it checks if the record exists, and if it doesn&#x27;t, the rollback operation is not executed. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object prepareFence(String xid, Long branchId, String actionName, Callback&lt;Object&gt; targetCallback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_TRIED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info(&quot;TCC fence prepare result: {}. xid: {}, branchId: {}&quot;, result, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (result) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return targetCallback.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TCCFenceException(String.format(&quot;Insert tcc fence record error, prepare fence failed. xid= %s, branchId= %s&quot;, xid, branchId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FrameworkErrorCode.InsertRecordError);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TCCFenceException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The processing logic in the Rollback phase is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean rollbackFence(Method rollbackMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    String xid, Long branchId, Object[] args, String actionName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // non_rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //The rollback logic is not executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (TCCFenceConstant.STATUS_ROLLBACKED == tccFenceDO.getStatus() || TCCFenceConstant.STATUS_SUSPENDED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.info(&quot;Branch transaction had already rollbacked before, idempotency rejected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (TCCFenceConstant.STATUS_COMMITTED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (LOGGER.isWarnEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOGGER.warn(&quot;Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}&quot;, xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, rollbackMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_ROLLBACKED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>updateStatusAndInvokeTargetMethod method executes the following SQL:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> tcc_fence_log </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gmt_modified </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> xid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain">  branch_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As we can see, it updates the value of the status field in the tcc_fence_log table from STATUS_TRIED to STATUS_ROLLBACKED. If the update is successful, the rollback logic is executed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-hanging">4.3 Hanging<a href="#43-hanging" class="hash-link" aria-label="Direct link to 4.3 Hanging" title="Direct link to 4.3 Hanging">â</a></h3><p>Hanging refers to a situation where, due to network issues, the RM did not receive the try instruction initially, but after executing the rollback, the RM receives the try instruction and successfully reserves resources. This leads to the inability to release the reserved resources, as shown in the following diagram:</p><p><img loading="lazy" alt="fence-suspend" src="/seata.github.io/assets/images/fence-suspend-054f87611ab16153c07bd28495c6902c.png" width="451" height="193" class="img_ev3q"></p><p>Seata solves this problem by checking if there is a record for the current xid in the tcc_fence_log table before executing the rollback method. If there is no record, it inserts a new record into the tcc_fence_log table with the status STATUS_SUSPENDED and does not perform the rollback operation. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean rollbackFence(Method rollbackMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    String xid, Long branchId, Object[] args, String actionName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // non_rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_SUSPENDED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, rollbackMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_ROLLBACKED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When executing the try phase method, a record for the current xid is first inserted into the tcc_fence_log table, which causes a primary key conflict. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object prepareFence(String xid, Long branchId, String actionName, Callback&lt;Object&gt; targetCallback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_TRIED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TCCFenceException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e.getErrcode() == FrameworkErrorCode.DuplicateKeyException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error(&quot;Branch transaction has already rollbacked before,prepare fence failed. xid= {},branchId = {}&quot;, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addToLogCleanQueue(xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: The queryTCCFenceDO method in the SQL statement uses for update, so there is no need to worry about not being able to determine the execution result of the local transaction in the rollback method due to the inability to obtain records from the tcc_fence_log table.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-summary">5 Summary<a href="#5-summary" class="hash-link" aria-label="Direct link to 5 Summary" title="Direct link to 5 Summary">â</a></h3><p>TCC mode is a very important transaction mode in distributed transactions. However, idempotence, hanging, and empty rollback have always been issues that need to be considered in TCC mode. The Seata framework perfectly solves these problems in version 1.5.1.
The operations on the tcc_fence_log table also need to consider transaction control. Seata uses a proxy data source to execute the operations on the tcc_fence_log table and the RM business operations in the same local transaction. This ensures that the local operations and the operations on the tcc_fence_log table succeed or fail together.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/seata-tcc-fence.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/seata.github.io/blog/seata-connect-data-and-application"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Seata:Bridging Data and Applications</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/seata.github.io/blog/seata-snowflake-explain"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Q&amp;A on the New Version of Snowflake Algorithm</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-tcc" class="table-of-contents__link toc-highlight">1 TCC</a><ul><li><a href="#11-try-commit" class="table-of-contents__link toc-highlight">1.1 try-commit</a></li><li><a href="#12-try-cancel" class="table-of-contents__link toc-highlight">1.2 try-cancel</a></li></ul></li><li><a href="#2-tcc-advantages" class="table-of-contents__link toc-highlight">2 TCC Advantages</a><ul><li><a href="#21-asynchronous-commit" class="table-of-contents__link toc-highlight">2.1 Asynchronous Commit</a></li><li><a href="#22-same-database-mode" class="table-of-contents__link toc-highlight">2.2 Same-Database Mode</a></li></ul></li><li><a href="#3-rm-code-example" class="table-of-contents__link toc-highlight">3 RM Code Example</a></li><li><a href="#4-issues-with-tcc" class="table-of-contents__link toc-highlight">4 Issues with TCC</a><ul><li><a href="#41-idempotence" class="table-of-contents__link toc-highlight">4.1 Idempotence</a></li><li><a href="#42-empty-rollback" class="table-of-contents__link toc-highlight">4.2 Empty Rollback</a></li><li><a href="#43-hanging" class="table-of-contents__link toc-highlight">4.3 Hanging</a></li><li><a href="#5-summary" class="table-of-contents__link toc-highlight">5 Summary</a></li></ul></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/seata.github.io/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/seata.github.io/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright Â© 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
<script src="/seata.github.io/assets/js/runtime~main.c3f2affa.js"></script>
<script src="/seata.github.io/assets/js/main.36bade35.js"></script>
</body>
</html>