"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[54595],{51897:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>g,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var s=n(74848),o=n(28453);const r={title:"seata-golang \u901a\u4fe1\u6a21\u578b\u8be6\u89e3",keywords:["seata","seata-golang","seata-go","getty","\u5206\u5e03\u5f0f\u4e8b\u52a1"],description:"\u672c\u6587\u8be6\u7ec6\u8bb2\u8ff0 seata-golang \u5e95\u5c42 rpc \u901a\u4fe1\u7684\u5b9e\u73b0\u539f\u7406",author:"\u5218\u6653\u654f",date:"2021/01/04"},a="\u57fa\u4e8e getty \u7684 seata-golang \u901a\u4fe1\u6a21\u578b\u8be6\u89e3",i={permalink:"/seata.github.io/zh-cn/blog/seata-golang-communication-mode",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/zh-cn/docusaurus-plugin-content-blog/seata-golang-communication-mode.md",source:"@site/i18n/zh-cn/docusaurus-plugin-content-blog/seata-golang-communication-mode.md",title:"seata-golang \u901a\u4fe1\u6a21\u578b\u8be6\u89e3",description:"\u672c\u6587\u8be6\u7ec6\u8bb2\u8ff0 seata-golang \u5e95\u5c42 rpc \u901a\u4fe1\u7684\u5b9e\u73b0\u539f\u7406",date:"2021-01-04T00:00:00.000Z",formattedDate:"2021\u5e741\u67084\u65e5",tags:[],readingTime:18.72,hasTruncateMarker:!1,authors:[{name:"\u5218\u6653\u654f"}],frontMatter:{title:"seata-golang \u901a\u4fe1\u6a21\u578b\u8be6\u89e3",keywords:["seata","seata-golang","seata-go","getty","\u5206\u5e03\u5f0f\u4e8b\u52a1"],description:"\u672c\u6587\u8be6\u7ec6\u8bb2\u8ff0 seata-golang \u5e95\u5c42 rpc \u901a\u4fe1\u7684\u5b9e\u73b0\u539f\u7406",author:"\u5218\u6653\u654f",date:"2021/01/04"},unlisted:!1,prevItem:{title:"Seata\u914d\u7f6e\u7ba1\u7406\u539f\u7406\u89e3\u6790",permalink:"/seata.github.io/zh-cn/blog/seata-config-manager"},nextItem:{title:"Seata\u6570\u636e\u6e90\u4ee3\u7406\u89e3\u6790",permalink:"/seata.github.io/zh-cn/blog/seata-datasource-proxy"}},c={authorsImageUrls:[void 0]},l=[{value:"\u4e00\u3001\u7b80\u4ecb",id:"\u4e00\u7b80\u4ecb",level:2},{value:"\u4e8c\u3001\u5982\u4f55\u57fa\u4e8e getty \u5b9e\u73b0 RPC \u901a\u4fe1",id:"\u4e8c\u5982\u4f55\u57fa\u4e8e-getty-\u5b9e\u73b0-rpc-\u901a\u4fe1",level:2},{value:"1. \u5efa\u7acb\u8fde\u63a5",id:"1-\u5efa\u7acb\u8fde\u63a5",level:3},{value:"2. \u6536\u53d1\u62a5\u6587",id:"2-\u6536\u53d1\u62a5\u6587",level:3},{value:"3. \u5e95\u5c42\u5904\u7406\u7f51\u7edc\u62a5\u6587\u7684\u903b\u8f91\u5982\u4f55\u4e0e\u4e1a\u52a1\u903b\u8f91\u89e3\u8026",id:"3-\u5e95\u5c42\u5904\u7406\u7f51\u7edc\u62a5\u6587\u7684\u903b\u8f91\u5982\u4f55\u4e0e\u4e1a\u52a1\u903b\u8f91\u89e3\u8026",level:3},{value:"4. \u5177\u4f53\u5b9e\u73b0",id:"4-\u5177\u4f53\u5b9e\u73b0",level:3},{value:"4.1 \u7f16\u89e3\u7801\u534f\u8bae\u5b9e\u73b0",id:"41-\u7f16\u89e3\u7801\u534f\u8bae\u5b9e\u73b0",level:4},{value:"4.2 Client \u7aef\u5b9e\u73b0",id:"42-client-\u7aef\u5b9e\u73b0",level:4},{value:"4.3 Server \u7aef Transaction Coordinator \u5b9e\u73b0",id:"43-server-\u7aef-transaction-coordinator-\u5b9e\u73b0",level:4},{value:"4.4 session manager \u5206\u6790",id:"44-session-manager-\u5206\u6790",level:4},{value:"\u4e09\u3001seata-golang \u7684\u672a\u6765",id:"\u4e09seata-golang-\u7684\u672a\u6765",level:2},{value:"<strong>\u4f5c\u8005\u7b80\u4ecb</strong>",id:"\u4f5c\u8005\u7b80\u4ecb",level:3},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:4}];function d(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"\u4f5c\u8005 | \u5218\u6653\u654f \u4e8e\u96e8"}),"\n",(0,s.jsx)(t.h2,{id:"\u4e00\u7b80\u4ecb",children:"\u4e00\u3001\u7b80\u4ecb"}),"\n",(0,s.jsxs)(t.p,{children:["Java \u7684\u4e16\u754c\u91cc\uff0c\u5927\u5bb6\u5e7f\u6cdb\u4f7f\u7528\u7684\u4e00\u4e2a\u9ad8\u6027\u80fd\u7f51\u7edc\u901a\u4fe1\u6846\u67b6 netty\uff0c\u5f88\u591a RPC \u6846\u67b6\u90fd\u662f\u57fa\u4e8e netty \u6765\u5b9e\u73b0\u7684\u3002\u5728 golang \u7684\u4e16\u754c\u91cc\uff0c",(0,s.jsx)(t.a,{href:"https://github.com/AlexStocks/getty",children:"getty"})," \u4e5f\u662f\u4e00\u4e2a\u7c7b\u4f3c netty \u7684\u9ad8\u6027\u80fd\u7f51\u7edc\u901a\u4fe1\u5e93\u3002getty \u6700\u521d\u7531 dubbogo \u9879\u76ee\u8d1f\u8d23\u4eba\u4e8e\u96e8\u5f00\u53d1\uff0c\u4f5c\u4e3a\u5e95\u5c42\u901a\u4fe1\u5e93\u5728 ",(0,s.jsx)(t.a,{href:"https://github.com/apache/dubbo-go",children:"dubbo-go"})," \u4e2d\u4f7f\u7528\u3002\u968f\u7740 dubbo-go \u6350\u732e\u7ed9 apache \u57fa\u91d1\u4f1a\uff0c\u5728\u793e\u533a\u5c0f\u4f19\u4f34\u7684\u5171\u540c\u52aa\u529b\u4e0b\uff0cgetty \u4e5f\u6700\u7ec8\u8fdb\u5165\u5230 apache \u8fd9\u4e2a\u5927\u5bb6\u5ead\uff0c\u5e76\u6539\u540d ",(0,s.jsx)(t.a,{href:"https://github.com/apache/dubbo-getty",children:"dubbo-getty"})," \u3002"]}),"\n",(0,s.jsx)(t.p,{children:"18 \u5e74\u7684\u65f6\u5019\uff0c\u6211\u5728\u516c\u53f8\u91cc\u5b9e\u8df5\u5fae\u670d\u52a1\uff0c\u5f53\u65f6\u9047\u5230\u6700\u5927\u7684\u95ee\u9898\u5c31\u662f\u5206\u5e03\u5f0f\u4e8b\u52a1\u95ee\u9898\u3002\u540c\u5e74\uff0c\u963f\u91cc\u5728\u793e\u533a\u5f00\u6e90\u4ed6\u4eec\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u89e3\u51b3\u65b9\u6848\uff0c\u6211\u4e5f\u5f88\u5feb\u5173\u6ce8\u5230\u8fd9\u4e2a\u9879\u76ee\uff0c\u8d77\u521d\u8fd8\u53eb fescar\uff0c\u540e\u6765\u66f4\u540d seata\u3002\u7531\u4e8e\u6211\u5bf9\u5f00\u6e90\u6280\u672f\u5f88\u611f\u5174\u8da3\uff0c\u52a0\u4e86\u5f88\u591a\u793e\u533a\u7fa4\uff0c\u5f53\u65f6\u4e5f\u5f88\u5173\u6ce8 dubbo-go \u8fd9\u4e2a\u9879\u76ee\uff0c\u5728\u91cc\u9762\u9ed8\u9ed8\u6f5c\u6c34\u3002\u968f\u7740\u5bf9 seata \u7684\u4e86\u89e3\uff0c\u9010\u6e10\u840c\u751f\u4e86\u505a\u4e00\u4e2a go \u7248\u672c\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u6846\u67b6\u7684\u60f3\u6cd5\u3002"}),"\n",(0,s.jsx)(t.p,{children:"\u8981\u505a\u4e00\u4e2a golang \u7248\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u6846\u67b6\uff0c\u9996\u8981\u7684\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u5982\u4f55\u5b9e\u73b0 RPC \u901a\u4fe1\u3002dubbo-go \u5c31\u662f\u5f88\u597d\u7684\u4e00\u4e2a\u4f8b\u5b50\u6446\u5728\u773c\u524d\uff0c\u9042\u5f00\u59cb\u7814\u7a76 dubbo-go \u7684\u5e95\u5c42 getty\u3002"}),"\n",(0,s.jsx)(t.h2,{id:"\u4e8c\u5982\u4f55\u57fa\u4e8e-getty-\u5b9e\u73b0-rpc-\u901a\u4fe1",children:"\u4e8c\u3001\u5982\u4f55\u57fa\u4e8e getty \u5b9e\u73b0 RPC \u901a\u4fe1"}),"\n",(0,s.jsx)(t.p,{children:"getty \u6846\u67b6\u7684\u6574\u4f53\u6a21\u578b\u56fe\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://img.alicdn.com/imgextra/i1/O1CN011TIcL01jY4JaweOfV_!!6000000004559-2-tps-954-853.png",alt:"image.png"})}),"\n",(0,s.jsx)(t.p,{children:"\u4e0b\u9762\u7ed3\u5408\u76f8\u5173\u4ee3\u7801\uff0c\u8be6\u8ff0 seata-golang \u7684 RPC \u901a\u4fe1\u8fc7\u7a0b\u3002"}),"\n",(0,s.jsx)(t.h3,{id:"1-\u5efa\u7acb\u8fde\u63a5",children:"1. \u5efa\u7acb\u8fde\u63a5"}),"\n",(0,s.jsxs)(t.p,{children:["\u5b9e\u73b0 RPC \u901a\u4fe1\uff0c\u9996\u5148\u8981\u5efa\u7acb\u7f51\u7edc\u8fde\u63a5\u5427\uff0c\u6211\u4eec\u4ece ",(0,s.jsx)(t.a,{href:"https://github.com/apache/dubbo-getty/blob/master/client.go",children:"client.go"})," \u5f00\u59cb\u770b\u8d77\u3002"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func (c *client) connect() {\n\tvar (\n\t\terr error\n\t\tss  Session\n\t)\n\n\tfor {\n        // \u5efa\u7acb\u4e00\u4e2a session \u8fde\u63a5\n\t\tss = c.dial()\n\t\tif ss == nil {\n\t\t\t// client has been closed\n\t\t\tbreak\n\t\t}\n\t\terr = c.newSession(ss)\n\t\tif err == nil {\n            // \u6536\u53d1\u62a5\u6587\n\t\t\tss.(*session).run()\n\t\t\t// \u6b64\u5904\u7701\u7565\u90e8\u5206\u4ee3\u7801\n      \n\t\t\tbreak\n\t\t}\n\t\t// don't distinguish between tcp connection and websocket connection. Because\n\t\t// gorilla/websocket/conn.go:(Conn)Close also invoke net.Conn.Close()\n\t\tss.Conn().Close()\n\t}\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"connect()"})," \u65b9\u6cd5\u901a\u8fc7 ",(0,s.jsx)(t.code,{children:"dial()"})," \u65b9\u6cd5\u5f97\u5230\u4e86\u4e00\u4e2a session \u8fde\u63a5\uff0c\u8fdb\u5165 dial() \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"func (c *client) dial() Session {\n\tswitch c.endPointType {\n\tcase TCP_CLIENT:\n\t\treturn c.dialTCP()\n\tcase UDP_CLIENT:\n\t\treturn c.dialUDP()\n\tcase WS_CLIENT:\n\t\treturn c.dialWS()\n\tcase WSS_CLIENT:\n\t\treturn c.dialWSS()\n\t}\n\n\treturn nil\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u6211\u4eec\u5173\u6ce8\u7684\u662f TCP \u8fde\u63a5\uff0c\u6240\u4ee5\u7ee7\u7eed\u8fdb\u5165 ",(0,s.jsx)(t.code,{children:"c.dialTCP()"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func (c *client) dialTCP() Session {\n\tvar (\n\t\terr  error\n\t\tconn net.Conn\n\t)\n\n\tfor {\n\t\tif c.IsClosed() {\n\t\t\treturn nil\n\t\t}\n\t\tif c.sslEnabled {\n\t\t\tif sslConfig, err := c.tlsConfigBuilder.BuildTlsConfig(); err == nil && sslConfig != nil {\n\t\t\t\td := &net.Dialer{Timeout: connectTimeout}\n\t\t\t\t// \u5efa\u7acb\u52a0\u5bc6\u8fde\u63a5\n\t\t\t\tconn, err = tls.DialWithDialer(d, "tcp", c.addr, sslConfig)\n\t\t\t}\n\t\t} else {\n            // \u5efa\u7acb tcp \u8fde\u63a5\n\t\t\tconn, err = net.DialTimeout("tcp", c.addr, connectTimeout)\n\t\t}\n\t\tif err == nil && gxnet.IsSameAddr(conn.RemoteAddr(), conn.LocalAddr()) {\n\t\t\tconn.Close()\n\t\t\terr = errSelfConnect\n\t\t}\n\t\tif err == nil {\n            // \u8fd4\u56de\u4e00\u4e2a TCPSession\n\t\t\treturn newTCPSession(conn, c)\n\t\t}\n\n\t\tlog.Infof("net.DialTimeout(addr:%s, timeout:%v) = error:%+v", c.addr, connectTimeout, perrors.WithStack(err))\n\t\t<-wheel.After(connectInterval)\n\t}\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"\u81f3\u6b64\uff0c\u6211\u4eec\u77e5\u9053\u4e86 getty \u5982\u4f55\u5efa\u7acb TCP \u8fde\u63a5\uff0c\u5e76\u8fd4\u56de TCPSession\u3002"}),"\n",(0,s.jsx)(t.h3,{id:"2-\u6536\u53d1\u62a5\u6587",children:"2. \u6536\u53d1\u62a5\u6587"}),"\n",(0,s.jsxs)(t.p,{children:["\u90a3\u5b83\u662f\u600e\u4e48\u6536\u53d1\u62a5\u6587\u7684\u5462\uff0c\u6211\u4eec\u56de\u5230 connection \u65b9\u6cd5\u63a5\u7740\u5f80\u4e0b\u770b\uff0c\u6709\u8fd9\u6837\u4e00\u884c ",(0,s.jsx)(t.code,{children:"ss.(*session).run()"}),"\uff0c\u5728\u8fd9\u884c\u4ee3\u7801\u4e4b\u540e\u4ee3\u7801\u90fd\u662f\u5f88\u7b80\u5355\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u731c\u6d4b\u8fd9\u884c\u4ee3\u7801\u8fd0\u884c\u7684\u903b\u8f91\u91cc\u9762\u4e00\u5b9a\u5305\u542b\u6536\u53d1\u62a5\u6587\u7684\u903b\u8f91\uff0c\u63a5\u7740\u8fdb\u5165 ",(0,s.jsx)(t.code,{children:"run()"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func (s *session) run() {\n\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n  \n\tgo s.handleLoop()\n\tgo s.handlePackage()\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u8fd9\u91cc\u8d77\u4e86\u4e24\u4e2a goroutine\uff0c",(0,s.jsx)(t.code,{children:"handleLoop"})," \u548c ",(0,s.jsx)(t.code,{children:"handlePackage"}),"\uff0c\u770b\u5b57\u9762\u610f\u601d\u7b26\u5408\u6211\u4eec\u7684\u731c\u60f3\uff0c\u8fdb\u5165 ",(0,s.jsx)(t.code,{children:"handleLoop()"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func (s *session) handleLoop() {\n    // \u7701\u7565\u90e8\u5206\u4ee3\u7801\n  \n\tfor {\n\t\t// A select blocks until one of its cases is ready to run.\n\t\t// It choose one at random if multiple are ready. Otherwise it choose default branch if none is ready.\n\t\tselect {\n\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n      \n\t\tcase outPkg, ok = <-s.wQ:\n\t\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n\n\t\t\tiovec = iovec[:0]\n\t\t\tfor idx := 0; idx < maxIovecNum; idx++ {\n        // \u901a\u8fc7 s.writer \u5c06 interface{} \u7c7b\u578b\u7684 outPkg \u7f16\u7801\u6210\u4e8c\u8fdb\u5236\u7684\u6bd4\u7279\n\t\t\t\tpkgBytes, err = s.writer.Write(s, outPkg)\n\t\t\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n        \n\t\t\t\tiovec = append(iovec, pkgBytes)\n\n                //\u7701\u7565\u90e8\u5206\u4ee3\u7801\n\t\t\t}\n            // \u5c06\u8fd9\u4e9b\u4e8c\u8fdb\u5236\u6bd4\u7279\u53d1\u9001\u51fa\u53bb\n\t\t\terr = s.WriteBytesArray(iovec[:]...)\n\t\t\tif err != nil {\n\t\t\t\tlog.Errorf("%s, [session.handleLoop]s.WriteBytesArray(iovec len:%d) = error:%+v",\n\t\t\t\t\ts.sessionToken(), len(iovec), perrors.WithStack(err))\n\t\t\t\ts.stop()\n\t\t\t\t// break LOOP\n\t\t\t\tflag = false\n\t\t\t}\n\n\t\tcase <-wheel.After(s.period):\n\t\t\tif flag {\n\t\t\t\tif wsFlag {\n\t\t\t\t\terr := wsConn.writePing()\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tlog.Warnf("wsConn.writePing() = error:%+v", perrors.WithStack(err))\n\t\t\t\t\t}\n\t\t\t\t}\n                // \u5b9a\u65f6\u6267\u884c\u7684\u903b\u8f91\uff0c\u5fc3\u8df3\u7b49\n\t\t\t\ts.listener.OnCron(s)\n\t\t\t}\n\t\t}\n\t}\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["\u901a\u8fc7\u4e0a\u9762\u7684\u4ee3\u7801\uff0c\u6211\u4eec\u4e0d\u96be\u53d1\u73b0\uff0c",(0,s.jsx)(t.code,{children:"handleLoop()"})," \u65b9\u6cd5\u5904\u7406\u7684\u662f\u53d1\u9001\u62a5\u6587\u7684\u903b\u8f91\uff0cRPC \u9700\u8981\u53d1\u9001\u7684\u6d88\u606f\u9996\u5148\u7531 ",(0,s.jsx)(t.code,{children:"s.writer"})," \u7f16\u7801\u6210\u4e8c\u8fdb\u5236\u6bd4\u7279\uff0c\u7136\u540e\u901a\u8fc7\u5efa\u7acb\u7684 TCP \u8fde\u63a5\u53d1\u9001\u51fa\u53bb\u3002\u8fd9\u4e2a ",(0,s.jsx)(t.code,{children:"s.writer"})," \u5bf9\u5e94\u7684 Writer \u63a5\u53e3\u662f RPC \u6846\u67b6\u5fc5\u987b\u8981\u5b9e\u73b0\u7684\u4e00\u4e2a\u63a5\u53e3\u3002"]}),"\n",(0,s.jsxs)(t.p,{children:["\u7ee7\u7eed\u770b ",(0,s.jsx)(t.code,{children:"handlePackage()"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func (s *session) handlePackage() {\n    // \u7701\u7565\u90e8\u5206\u4ee3\u7801\n\n\tif _, ok := s.Connection.(*gettyTCPConn); ok {\n\t\tif s.reader == nil {\n\t\t\terrStr := fmt.Sprintf("session{name:%s, conn:%#v, reader:%#v}", s.name, s.Connection, s.reader)\n\t\t\tlog.Error(errStr)\n\t\t\tpanic(errStr)\n\t\t}\n\n\t\terr = s.handleTCPPackage()\n\t} else if _, ok := s.Connection.(*gettyWSConn); ok {\n\t\terr = s.handleWSPackage()\n\t} else if _, ok := s.Connection.(*gettyUDPConn); ok {\n\t\terr = s.handleUDPPackage()\n\t} else {\n\t\tpanic(fmt.Sprintf("unknown type session{%#v}", s))\n\t}\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["\u8fdb\u5165 ",(0,s.jsx)(t.code,{children:"handleTCPPackage()"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func (s *session) handleTCPPackage() error {\n    // \u7701\u7565\u90e8\u5206\u4ee3\u7801\n\n\tconn = s.Connection.(*gettyTCPConn)\n\tfor {\n\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n\n\t\tbufLen = 0\n\t\tfor {\n\t\t\t// for clause for the network timeout condition check\n\t\t\t// s.conn.SetReadTimeout(time.Now().Add(s.rTimeout))\n            // \u4ece TCP \u8fde\u63a5\u4e2d\u6536\u5230\u62a5\u6587\n\t\t\tbufLen, err = conn.recv(buf)\n\t\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n      \n\t\t\tbreak\n\t\t}\n\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n    \n        // \u5c06\u6536\u5230\u7684\u62a5\u6587\u4e8c\u8fdb\u5236\u6bd4\u7279\u5199\u5165 pkgBuf\n\t\tpktBuf.Write(buf[:bufLen])\n\t\tfor {\n\t\t\tif pktBuf.Len() <= 0 {\n\t\t\t\tbreak\n\t\t\t}\n            // \u901a\u8fc7 s.reader \u5c06\u6536\u5230\u7684\u62a5\u6587\u89e3\u7801\u6210 RPC \u6d88\u606f\n\t\t\tpkg, pkgLen, err = s.reader.Read(s, pktBuf.Bytes())\n\t\t\t// \u7701\u7565\u90e8\u5206\u4ee3\u7801\n\n      s.UpdateActive()\n            // \u5c06\u6536\u5230\u7684\u6d88\u606f\u653e\u5165 TaskQueue \u4f9b RPC \u6d88\u8d39\u7aef\u6d88\u8d39\n\t\t\ts.addTask(pkg)\n\t\t\tpktBuf.Next(pkgLen)\n\t\t\t// continue to handle case 5\n\t\t}\n\t\tif exit {\n\t\t\tbreak\n\t\t}\n\t}\n\n\treturn perrors.WithStack(err)\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"\u4ece\u4e0a\u9762\u7684\u4ee3\u7801\u903b\u8f91\u6211\u4eec\u5206\u6790\u51fa\uff0cRPC \u6d88\u8d39\u7aef\u9700\u8981\u5c06\u4ece TCP \u8fde\u63a5\u6536\u5230\u7684\u4e8c\u8fdb\u5236\u6bd4\u7279\u62a5\u6587\u89e3\u7801\u6210 RPC \u80fd\u6d88\u8d39\u7684\u6d88\u606f\uff0c\u8fd9\u4e2a\u5de5\u4f5c\u7531 s.reader \u5b9e\u73b0\uff0c\u6240\u4ee5\uff0c\u6211\u4eec\u8981\u6784\u5efa RPC \u901a\u4fe1\u5c42\u4e5f\u9700\u8981\u5b9e\u73b0 s.reader \u5bf9\u5e94\u7684 Reader \u63a5\u53e3\u3002"}),"\n",(0,s.jsx)(t.h3,{id:"3-\u5e95\u5c42\u5904\u7406\u7f51\u7edc\u62a5\u6587\u7684\u903b\u8f91\u5982\u4f55\u4e0e\u4e1a\u52a1\u903b\u8f91\u89e3\u8026",children:"3. \u5e95\u5c42\u5904\u7406\u7f51\u7edc\u62a5\u6587\u7684\u903b\u8f91\u5982\u4f55\u4e0e\u4e1a\u52a1\u903b\u8f91\u89e3\u8026"}),"\n",(0,s.jsx)(t.p,{children:"\u6211\u4eec\u90fd\u77e5\u9053\uff0cnetty \u901a\u8fc7 boss \u7ebf\u7a0b\u548c worker \u7ebf\u7a0b\u5b9e\u73b0\u4e86\u5e95\u5c42\u7f51\u7edc\u903b\u8f91\u548c\u4e1a\u52a1\u903b\u8f91\u7684\u89e3\u8026\u3002\u90a3\u4e48\uff0cgetty \u662f\u5982\u4f55\u5b9e\u73b0\u7684\u5462\uff1f"}),"\n",(0,s.jsxs)(t.p,{children:["\u5728 ",(0,s.jsx)(t.code,{children:"handlePackage()"})," \u65b9\u6cd5\u6700\u540e\uff0c\u6211\u4eec\u770b\u5230\uff0c\u6536\u5230\u7684\u6d88\u606f\u88ab\u653e\u5165\u4e86 ",(0,s.jsx)(t.code,{children:"s.addTask(pkg)"})," \u8fd9\u4e2a\u65b9\u6cd5\uff0c\u63a5\u7740\u5f80\u4e0b\u5206\u6790\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func (s *session) addTask(pkg interface{}) {\n\tf := func() {\n\t\ts.listener.OnMessage(s, pkg)\n\t\ts.incReadPkgNum()\n\t}\n\tif taskPool := s.EndPoint().GetTaskPool(); taskPool != nil {\n\t\ttaskPool.AddTaskAlways(f)\n\t\treturn\n\t}\n\tf()\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"pkg"})," \u53c2\u6570\u4f20\u9012\u5230\u4e86\u4e00\u4e2a\u533f\u540d\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6700\u7ec8\u653e\u5165\u4e86 ",(0,s.jsx)(t.code,{children:"taskPool"}),"\u3002\u8fd9\u4e2a\u65b9\u6cd5\u5f88\u5173\u952e\uff0c\u5728\u6211\u540e\u6765\u5199 seata-golang \u4ee3\u7801\u7684\u65f6\u5019\uff0c\u5c31\u9047\u5230\u4e86\u4e00\u4e2a\u5751\uff0c\u8fd9\u4e2a\u5751\u540e\u9762\u5206\u6790\u3002"]}),"\n",(0,s.jsxs)(t.p,{children:["\u63a5\u7740\u6211\u4eec\u770b\u4e00\u4e0b ",(0,s.jsx)(t.a,{href:"https://github.com/dubbogo/gost/blob/master/sync/task_pool.go",children:"taskPool"})," \u7684\u5b9a\u4e49\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"// NewTaskPoolSimple build a simple task pool\nfunc NewTaskPoolSimple(size int) GenericTaskPool {\n\tif size < 1 {\n\t\tsize = runtime.NumCPU() * 100\n\t}\n\treturn &taskPoolSimple{\n\t\twork: make(chan task),\n\t\tsem:  make(chan struct{}, size),\n\t\tdone: make(chan struct{}),\n\t}\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u6784\u5efa\u4e86\u4e00\u4e2a\u7f13\u51b2\u5927\u5c0f\u4e3a size \uff08\u9ed8\u8ba4\u4e3a \xa0",(0,s.jsx)(t.code,{children:"runtime.NumCPU() * 100"}),"\uff09 \u7684 channel ",(0,s.jsx)(t.code,{children:"sem"}),"\u3002\u518d\u770b\u65b9\u6cd5 ",(0,s.jsx)(t.code,{children:"AddTaskAlways(t task)"}),"\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"func (p *taskPoolSimple) AddTaskAlways(t task) {\n\tselect {\n\tcase <-p.done:\n\t\treturn\n\tdefault:\n\t}\n\n\tselect {\n\tcase p.work <- t:\n\t\treturn\n\tdefault:\n\t}\n\tselect {\n\tcase p.work <- t:\n\tcase p.sem <- struct{}{}:\n\t\tp.wg.Add(1)\n\t\tgo p.worker(t)\n\tdefault:\n\t\tgoSafely(t)\n\t}\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"\u52a0\u5165\u7684\u4efb\u52a1\uff0c\u4f1a\u5148\u7531 len(p.sem) \u4e2a goroutine \u53bb\u6d88\u8d39\uff0c\u5982\u679c\u6ca1\u6709 goroutine \u7a7a\u95f2\uff0c\u5219\u4f1a\u542f\u52a8\u4e00\u4e2a\u4e34\u65f6\u7684 goroutine \u53bb\u8fd0\u884c t()\u3002\u76f8\u5f53\u4e8e\u6709 \xa0len(p.sem) \u4e2a goroutine \u7ec4\u6210\u4e86 goroutine pool\uff0cpool \u4e2d\u7684 goroutine \u53bb\u5904\u7406\u4e1a\u52a1\u903b\u8f91\uff0c\u800c\u4e0d\u662f\u7531\u5904\u7406\u7f51\u7edc\u62a5\u6587\u7684 goroutine \u53bb\u8fd0\u884c\u4e1a\u52a1\u903b\u8f91\uff0c\u4ece\u800c\u5b9e\u73b0\u4e86\u89e3\u8026\u3002\u5199 seata-golang \u65f6\u9047\u5230\u7684\u4e00\u4e2a\u5751\uff0c\u5c31\u662f\u5fd8\u8bb0\u8bbe\u7f6e taskPool \u9020\u6210\u4e86\u5904\u7406\u4e1a\u52a1\u903b\u8f91\u548c\u5904\u7406\u5e95\u5c42\u7f51\u7edc\u62a5\u6587\u903b\u8f91\u7684 goroutine \u662f\u540c\u4e00\u4e2a\uff0c\u6211\u5728\u4e1a\u52a1\u903b\u8f91\u4e2d\u963b\u585e\u7b49\u5f85\u4e00\u4e2a\u4efb\u52a1\u5b8c\u6210\u65f6\uff0c\u963b\u585e\u4e86\u6574\u4e2a goroutine\uff0c\u4f7f\u5f97\u963b\u585e\u671f\u95f4\u6536\u4e0d\u5230\u4efb\u4f55\u62a5\u6587\u3002"}),"\n",(0,s.jsx)(t.h3,{id:"4-\u5177\u4f53\u5b9e\u73b0",children:"4. \u5177\u4f53\u5b9e\u73b0"}),"\n",(0,s.jsxs)(t.p,{children:["\u4e0b\u9762\u7684\u4ee3\u7801\u89c1 ",(0,s.jsx)(t.a,{href:"https://github.com/apache/dubbo-getty/blob/master/getty.go",children:"getty.go"}),"\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"// Reader is used to unmarshal a complete pkg from buffer\ntype Reader interface {\n\tRead(Session, []byte) (interface{}, int, error)\n}\n\n// Writer is used to marshal pkg and write to session\ntype Writer interface {\n\t// if @Session is udpGettySession, the second parameter is UDPContext.\n\tWrite(Session, interface{}) ([]byte, error)\n}\n\n// ReadWriter interface use for handle application packages\ntype ReadWriter interface {\n\tReader\n\tWriter\n}\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"// EventListener is used to process pkg that received from remote session\ntype EventListener interface {\n\t// invoked when session opened\n\t// If the return error is not nil, @Session will be closed.\n\tOnOpen(Session) error\n\n\t// invoked when session closed.\n\tOnClose(Session)\n\n\t// invoked when got error.\n\tOnError(Session, error)\n\n\t// invoked periodically, its period can be set by (Session)SetCronPeriod\n\tOnCron(Session)\n\n\t// invoked when getty received a package. Pls attention that do not handle long time\n\t// logic processing in this func. You'd better set the package's maximum length.\n\t// If the message's length is greater than it, u should should return err in\n\t// Reader{Read} and getty will close this connection soon.\n\t//\n\t// If ur logic processing in this func will take a long time, u should start a goroutine\n\t// pool(like working thread pool in cpp) to handle the processing asynchronously. Or u\n\t// can do the logic processing in other asynchronous way.\n\t// !!!In short, ur OnMessage callback func should return asap.\n\t//\n\t// If this is a udp event listener, the second parameter type is UDPContext.\n\tOnMessage(Session, interface{})\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u901a\u8fc7\u5bf9\u6574\u4e2a getty \u4ee3\u7801\u7684\u5206\u6790\uff0c\u6211\u4eec\u53ea\u8981\u5b9e\u73b0 \xa0",(0,s.jsx)(t.code,{children:"ReadWriter"})," \u6765\u5bf9 RPC \xa0\u6d88\u606f\u7f16\u89e3\u7801\uff0c\u518d\u5b9e\u73b0 ",(0,s.jsx)(t.code,{children:"EventListener"})," \u6765\u5904\u7406 RPC \u6d88\u606f\u7684\u5bf9\u5e94\u7684\u5177\u4f53\u903b\u8f91\uff0c\u5c06 ",(0,s.jsx)(t.code,{children:"ReadWriter"})," \u5b9e\u73b0\u548c ",(0,s.jsx)(t.code,{children:"EventLister"})," \u5b9e\u73b0\u6ce8\u5165\u5230 RPC \u7684 Client \u548c Server \u7aef\uff0c\u5219\u53ef\u5b9e\u73b0 RPC \u901a\u4fe1\u3002"]}),"\n",(0,s.jsx)(t.h4,{id:"41-\u7f16\u89e3\u7801\u534f\u8bae\u5b9e\u73b0",children:"4.1 \u7f16\u89e3\u7801\u534f\u8bae\u5b9e\u73b0"}),"\n",(0,s.jsxs)(t.p,{children:["\u4e0b\u9762\u662f seata \u534f\u8bae\u7684\u5b9a\u4e49\uff1a\n",(0,s.jsx)(t.img,{src:"https://cdn.nlark.com/yuque/0/2020/png/737378/1607180799872-5f96afb6-680d-4e69-8c95-b8fd1ac4c3a7.png#align=left&display=inline&height=209&margin=%5Bobject%20Object%5D&name=image-20201205214556457.png&originHeight=209&originWidth=690&size=18407&status=done&style=none&width=690",alt:"image-20201205214556457.png"})]}),"\n",(0,s.jsxs)(t.p,{children:["\u5728 ReadWriter \u63a5\u53e3\u7684\u5b9e\u73b0 ",(0,s.jsx)(t.a,{href:"https://github.com/opentrx/seata-golang",children:(0,s.jsx)(t.code,{children:"RpcPackageHandler"})})," \u4e2d\uff0c\u8c03\u7528 Codec \u65b9\u6cd5\u5bf9\u6d88\u606f\u4f53\u6309\u7167\u4e0a\u9762\u7684\u683c\u5f0f\u7f16\u89e3\u7801\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'// \u6d88\u606f\u7f16\u7801\u4e3a\u4e8c\u8fdb\u5236\u6bd4\u7279\nfunc MessageEncoder(codecType byte, in interface{}) []byte {\n\tswitch codecType {\n\tcase SEATA:\n\t\treturn SeataEncoder(in)\n\tdefault:\n\t\tlog.Errorf("not support codecType, %s", codecType)\n\t\treturn nil\n\t}\n}\n\n// \u4e8c\u8fdb\u5236\u6bd4\u7279\u89e3\u7801\u4e3a\u6d88\u606f\u4f53\nfunc MessageDecoder(codecType byte, in []byte) (interface{}, int) {\n\tswitch codecType {\n\tcase SEATA:\n\t\treturn SeataDecoder(in)\n\tdefault:\n\t\tlog.Errorf("not support codecType, %s", codecType)\n\t\treturn nil, 0\n\t}\n}\n'})}),"\n",(0,s.jsx)(t.h4,{id:"42-client-\u7aef\u5b9e\u73b0",children:"4.2 Client \u7aef\u5b9e\u73b0"}),"\n",(0,s.jsxs)(t.p,{children:["\u518d\u6765\u770b client \u7aef ",(0,s.jsx)(t.code,{children:"EventListener"})," \u7684\u5b9e\u73b0 ",(0,s.jsx)(t.a,{href:"https://github.com/opentrx/seata-golang/blob/dev/pkg/client/rpc_remoting_client.go",children:(0,s.jsx)(t.code,{children:"RpcRemotingClient"})}),"\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func (client *RpcRemoteClient) OnOpen(session getty.Session) error {\n\tgo func() \n\t\trequest := protocal.RegisterTMRequest{AbstractIdentifyRequest: protocal.AbstractIdentifyRequest{\n\t\t\tApplicationId:           client.conf.ApplicationId,\n\t\t\tTransactionServiceGroup: client.conf.TransactionServiceGroup,\n\t\t}}\n    // \u5efa\u7acb\u8fde\u63a5\u540e\u5411 Transaction Coordinator \u53d1\u8d77\u6ce8\u518c TransactionManager \u7684\u8bf7\u6c42\n\t\t_, err := client.sendAsyncRequestWithResponse(session, request, RPC_REQUEST_TIMEOUT)\n\t\tif err == nil {\n      // \u5c06\u4e0e Transaction Coordinator \u5efa\u7acb\u7684\u8fde\u63a5\u4fdd\u5b58\u5728\u8fde\u63a5\u6c60\u4f9b\u540e\u7eed\u4f7f\u7528\n\t\t\tclientSessionManager.RegisterGettySession(session)\n\t\t\tclient.GettySessionOnOpenChannel <- session.RemoteAddr()\n\t\t}\n\t}()\n\n\treturn nil\n}\n\n// OnError ...\nfunc (client *RpcRemoteClient) OnError(session getty.Session, err error) {\n\tclientSessionManager.ReleaseGettySession(session)\n}\n\n// OnClose ...\nfunc (client *RpcRemoteClient) OnClose(session getty.Session) {\n\tclientSessionManager.ReleaseGettySession(session)\n}\n\n// OnMessage ...\nfunc (client *RpcRemoteClient) OnMessage(session getty.Session, pkg interface{}) {\n\tlog.Info("received message:{%v}", pkg)\n\trpcMessage, ok := pkg.(protocal.RpcMessage)\n\tif ok {\n\t\theartBeat, isHeartBeat := rpcMessage.Body.(protocal.HeartBeatMessage)\n\t\tif isHeartBeat && heartBeat == protocal.HeartBeatMessagePong {\n\t\t\tlog.Debugf("received PONG from %s", session.RemoteAddr())\n\t\t}\n\t}\n\n\tif rpcMessage.MessageType == protocal.MSGTYPE_RESQUEST ||\n\t\trpcMessage.MessageType == protocal.MSGTYPE_RESQUEST_ONEWAY {\n\t\tlog.Debugf("msgId:%s, body:%v", rpcMessage.Id, rpcMessage.Body)\n      \n\t\t// \u5904\u7406\u4e8b\u52a1\u6d88\u606f\uff0c\u63d0\u4ea4 or \u56de\u6eda\n\t\tclient.onMessage(rpcMessage, session.RemoteAddr())\n\t} else {\n\t\tresp, loaded := client.futures.Load(rpcMessage.Id)\n\t\tif loaded {\n\t\t\tresponse := resp.(*getty2.MessageFuture)\n\t\t\tresponse.Response = rpcMessage.Body\n\t\t\tresponse.Done <- true\n\t\t\tclient.futures.Delete(rpcMessage.Id)\n\t\t}\n\t}\n}\n\n// OnCron ...\nfunc (client *RpcRemoteClient) OnCron(session getty.Session) {\n  // \u53d1\u9001\u5fc3\u8df3\n\tclient.defaultSendRequest(session, protocal.HeartBeatMessagePing)\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"clientSessionManager.RegisterGettySession(session)"})," \u7684\u903b\u8f91 4.4 \u5c0f\u8282\u5206\u6790\u3002"]}),"\n",(0,s.jsx)(t.h4,{id:"43-server-\u7aef-transaction-coordinator-\u5b9e\u73b0",children:"4.3 Server \u7aef Transaction Coordinator \u5b9e\u73b0"}),"\n",(0,s.jsxs)(t.p,{children:["\u4ee3\u7801\u89c1 ",(0,s.jsx)(t.a,{href:"https://github.com/opentrx/seata-golang/blob/dev/tc/server/default_coordinator_event_listener.go",children:(0,s.jsx)(t.code,{children:"DefaultCoordinator"})}),"\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func (coordinator *DefaultCoordinator) OnOpen(session getty.Session) error {\n\tlog.Infof("got getty_session:%s", session.Stat())\n\treturn nil\n}\n\nfunc (coordinator *DefaultCoordinator) OnError(session getty.Session, err error) {\n\t// \u91ca\u653e TCP \u8fde\u63a5\n  SessionManager.ReleaseGettySession(session)\n\tsession.Close()\n\tlog.Errorf("getty_session{%s} got error{%v}, will be closed.", session.Stat(), err)\n}\n\nfunc (coordinator *DefaultCoordinator) OnClose(session getty.Session) {\n\tlog.Info("getty_session{%s} is closing......", session.Stat())\n}\n\nfunc (coordinator *DefaultCoordinator) OnMessage(session getty.Session, pkg interface{}) {\n\tlog.Debugf("received message:{%v}", pkg)\n\trpcMessage, ok := pkg.(protocal.RpcMessage)\n\tif ok {\n\t\t_, isRegTM := rpcMessage.Body.(protocal.RegisterTMRequest)\n\t\tif isRegTM {\n      // \u5c06 TransactionManager \u4fe1\u606f\u548c TCP \u8fde\u63a5\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\n\t\t\tcoordinator.OnRegTmMessage(rpcMessage, session)\n\t\t\treturn\n\t\t}\n\n\t\theartBeat, isHeartBeat := rpcMessage.Body.(protocal.HeartBeatMessage)\n\t\tif isHeartBeat && heartBeat == protocal.HeartBeatMessagePing {\n\t\t\tcoordinator.OnCheckMessage(rpcMessage, session)\n\t\t\treturn\n\t\t}\n\n\t\tif rpcMessage.MessageType == protocal.MSGTYPE_RESQUEST ||\n\t\t\trpcMessage.MessageType == protocal.MSGTYPE_RESQUEST_ONEWAY {\n\t\t\tlog.Debugf("msgId:%s, body:%v", rpcMessage.Id, rpcMessage.Body)\n\t\t\t_, isRegRM := rpcMessage.Body.(protocal.RegisterRMRequest)\n\t\t\tif isRegRM {\n        // \u5c06 ResourceManager \u4fe1\u606f\u548c TCP \u8fde\u63a5\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\n\t\t\t\tcoordinator.OnRegRmMessage(rpcMessage, session)\n\t\t\t} else {\n\t\t\t\tif SessionManager.IsRegistered(session) {\n\t\t\t\t\tdefer func() {\n\t\t\t\t\t\tif err := recover(); err != nil {\n\t\t\t\t\t\t\tlog.Errorf("Catch Exception while do RPC, request: %v,err: %w", rpcMessage, err)\n\t\t\t\t\t\t}\n\t\t\t\t\t}()\n          // \u5904\u7406\u4e8b\u52a1\u6d88\u606f\uff0c\u5168\u5c40\u4e8b\u52a1\u6ce8\u518c\u3001\u5206\u652f\u4e8b\u52a1\u6ce8\u518c\u3001\u5206\u652f\u4e8b\u52a1\u63d0\u4ea4\u3001\u5168\u5c40\u4e8b\u52a1\u56de\u6eda\u7b49\n\t\t\t\t\tcoordinator.OnTrxMessage(rpcMessage, session)\n\t\t\t\t} else {\n\t\t\t\t\tsession.Close()\n\t\t\t\t\tlog.Infof("close a unhandled connection! [%v]", session)\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tresp, loaded := coordinator.futures.Load(rpcMessage.Id)\n\t\t\tif loaded {\n\t\t\t\tresponse := resp.(*getty2.MessageFuture)\n\t\t\t\tresponse.Response = rpcMessage.Body\n\t\t\t\tresponse.Done <- true\n\t\t\t\tcoordinator.futures.Delete(rpcMessage.Id)\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunc (coordinator *DefaultCoordinator) OnCron(session getty.Session) {\n\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"coordinator.OnRegTmMessage(rpcMessage, session)"})," \u6ce8\u518c Transaction Manager\uff0c",(0,s.jsx)(t.code,{children:"coordinator.OnRegRmMessage(rpcMessage, session)"})," \u6ce8\u518c Resource Manager\u3002\u5177\u4f53\u903b\u8f91\u5206\u6790\u89c1 4.4 \u5c0f\u8282\u3002\n\u6d88\u606f\u8fdb\u5165 ",(0,s.jsx)(t.code,{children:"coordinator.OnTrxMessage(rpcMessage, session)"})," \u65b9\u6cd5\uff0c\u5c06\u6309\u7167\u6d88\u606f\u7684\u7c7b\u578b\u7801\u8def\u7531\u5230\u5177\u4f53\u7684\u903b\u8f91\u5f53\u4e2d\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"\tswitch msg.GetTypeCode() {\n\tcase protocal.TypeGlobalBegin:\n\t\treq := msg.(protocal.GlobalBeginRequest)\n\t\tresp := coordinator.doGlobalBegin(req, ctx)\n\t\treturn resp\n\tcase protocal.TypeGlobalStatus:\n\t\treq := msg.(protocal.GlobalStatusRequest)\n\t\tresp := coordinator.doGlobalStatus(req, ctx)\n\t\treturn resp\n\tcase protocal.TypeGlobalReport:\n\t\treq := msg.(protocal.GlobalReportRequest)\n\t\tresp := coordinator.doGlobalReport(req, ctx)\n\t\treturn resp\n\tcase protocal.TypeGlobalCommit:\n\t\treq := msg.(protocal.GlobalCommitRequest)\n\t\tresp := coordinator.doGlobalCommit(req, ctx)\n\t\treturn resp\n\tcase protocal.TypeGlobalRollback:\n\t\treq := msg.(protocal.GlobalRollbackRequest)\n\t\tresp := coordinator.doGlobalRollback(req, ctx)\n\t\treturn resp\n\tcase protocal.TypeBranchRegister:\n\t\treq := msg.(protocal.BranchRegisterRequest)\n\t\tresp := coordinator.doBranchRegister(req, ctx)\n\t\treturn resp\n\tcase protocal.TypeBranchStatusReport:\n\t\treq := msg.(protocal.BranchReportRequest)\n\t\tresp := coordinator.doBranchReport(req, ctx)\n\t\treturn resp\n\tdefault:\n\t\treturn nil\n\t}\n"})}),"\n",(0,s.jsx)(t.h4,{id:"44-session-manager-\u5206\u6790",children:"4.4 session manager \u5206\u6790"}),"\n",(0,s.jsxs)(t.p,{children:["Client \u7aef\u540c Transaction Coordinator \u5efa\u7acb\u8fde\u63a5\u8d77\u8fde\u63a5\u540e\uff0c\u901a\u8fc7 ",(0,s.jsx)(t.code,{children:"clientSessionManager.RegisterGettySession(session)"})," \u5c06\u8fde\u63a5\u4fdd\u5b58\u5728 ",(0,s.jsx)(t.code,{children:"serverSessions = sync.Map{}"})," \u8fd9\u4e2a map \u4e2d\u3002map \u7684 key \u4e3a\u4ece session \u4e2d\u83b7\u53d6\u7684 RemoteAddress \u5373 Transaction Coordinator \u7684\u5730\u5740\uff0cvalue \u4e3a session\u3002\u8fd9\u6837\uff0cClient \u7aef\u5c31\u53ef\u4ee5\u901a\u8fc7 map \u4e2d\u7684\u4e00\u4e2a session \u6765\u5411 Transaction Coordinator \u6ce8\u518c Transaction Manager \u548c Resource Manager \u4e86\u3002\u5177\u4f53\u4ee3\u7801\u89c1 ",(0,s.jsxs)(t.a,{href:"https://github.com/opentrx/seata-golang/blob/dev/pkg/client/getty_client_session_manager.go",children:[(0,s.jsx)(t.code,{children:"getty_client_session_manager.go"}),"\u3002"]}),"\nTransaction Manager \u548c Resource Manager \u6ce8\u518c\u5230 Transaction Coordinator \u540e\uff0c\u4e00\u4e2a\u8fde\u63a5\u65e2\u6709\u53ef\u80fd\u7528\u6765\u53d1\u9001 TM \u6d88\u606f\u4e5f\u6709\u53ef\u80fd\u7528\u6765\u53d1\u9001 RM \u6d88\u606f\u3002\u6211\u4eec\u901a\u8fc7 RpcContext \u6765\u6807\u8bc6\u4e00\u4e2a\u8fde\u63a5\u4fe1\u606f\uff1a"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"type RpcContext struct {\n\tVersion                 string\n\tTransactionServiceGroup string\n\tClientRole              meta.TransactionRole\n\tApplicationId           string\n\tClientId                string\n\tResourceSets            *model.Set\n\tSession                 getty.Session\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"\u5f53\u6536\u5230\u4e8b\u52a1\u6d88\u606f\u65f6\uff0c\u6211\u4eec\u9700\u8981\u6784\u9020\u8fd9\u6837\u4e00\u4e2a RpcContext \u4f9b\u540e\u7eed\u4e8b\u52a1\u5904\u7406\u903b\u8f91\u4f7f\u7528\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u4f1a\u6784\u9020\u4e0b\u5217 map \u6765\u7f13\u5b58\u6620\u5c04\u5173\u7cfb\uff1a"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"var (\n\t// session -> transactionRole\n\t// TM will register before RM, if a session is not the TM registered,\n\t// it will be the RM registered\n\tsession_transactionroles = sync.Map{}\n\n\t// session -> applicationId\n\tidentified_sessions = sync.Map{}\n\n\t// applicationId -> ip -> port -> session\n\tclient_sessions = sync.Map{}\n\n\t// applicationId -> resourceIds\n\tclient_resources = sync.Map{}\n)\n"})}),"\n",(0,s.jsxs)(t.p,{children:["\u8fd9\u6837\uff0cTransaction Manager \u548c Resource Manager \u5206\u522b\u901a\u8fc7 ",(0,s.jsx)(t.code,{children:"coordinator.OnRegTmMessage(rpcMessage, session)"})," \u548c ",(0,s.jsx)(t.code,{children:"coordinator.OnRegRmMessage(rpcMessage, session)"})," \u6ce8\u518c\u5230 Transaction Coordinator \u65f6\uff0c\u4f1a\u5728\u4e0a\u8ff0 client_sessions map \u4e2d\u7f13\u5b58 applicationId\u3001ip\u3001port \u4e0e session \u7684\u5173\u7cfb\uff0c\u5728 client_resources map \u4e2d\u7f13\u5b58 applicationId \u4e0e resourceIds\uff08\u4e00\u4e2a\u5e94\u7528\u53ef\u80fd\u5b58\u5728\u591a\u4e2a Resource Manager\uff09 \u7684\u5173\u7cfb\u3002\u5728\u9700\u8981\u65f6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4e0a\u8ff0\u6620\u5c04\u5173\u7cfb\u6784\u9020\u4e00\u4e2a RpcContext\u3002\u8fd9\u90e8\u5206\u7684\u5b9e\u73b0\u548c java \u7248 seata \u6709\u5f88\u5927\u7684\u4e0d\u540c\uff0c\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u4e00\u4e0b\u3002\u5177\u4f53\u4ee3\u7801\u89c1 ",(0,s.jsxs)(t.a,{href:"https://github.com/opentrx/seata-golang/blob/dev/tc/server/getty_session_manager.go",children:[(0,s.jsx)(t.code,{children:"getty_session_manager.go"}),"\u3002"]}),"\n\u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u5206\u6790\u5b8c\u4e86 ",(0,s.jsx)(t.a,{href:"https://github.com/opentrx/seata-golang",children:"seata-golang"})," \u6574\u4e2a RPC \u901a\u4fe1\u6a21\u578b\u7684\u673a\u5236\u3002"]}),"\n",(0,s.jsx)(t.h2,{id:"\u4e09seata-golang-\u7684\u672a\u6765",children:"\u4e09\u3001seata-golang \u7684\u672a\u6765"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://github.com/opentrx/seata-golang",children:"seata-golang"})," \xa0\u4ece\u4eca\u5e74 4 \u6708\u4efd\u5f00\u59cb\u5f00\u53d1\uff0c\u5230 8 \u6708\u4efd\u57fa\u672c\u5b9e\u73b0\u548c java \u7248 ",(0,s.jsx)(t.a,{href:"https://github.com/apache/incubator-seata",children:"seata 1.2"})," \u534f\u8bae\u7684\u4e92\u901a\uff0c\u5bf9 mysql \u6570\u636e\u5e93\u5b9e\u73b0\u4e86 AT \u6a21\u5f0f\uff08\u81ea\u52a8\u534f\u8c03\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u63d0\u4ea4\u56de\u6eda\uff09\uff0c\u5b9e\u73b0\u4e86 TCC \u6a21\u5f0f\uff0cTC \u7aef\u4f7f\u7528 mysql \u5b58\u50a8\u6570\u636e\uff0c\u4f7f TC \u53d8\u6210\u4e00\u4e2a\u65e0\u72b6\u6001\u5e94\u7528\u652f\u6301\u9ad8\u53ef\u7528\u90e8\u7f72\u3002\u4e0b\u56fe\u5c55\u793a\u4e86 AT \u6a21\u5f0f\u7684\u539f\u7406\uff1a",(0,s.jsx)(t.img,{src:"https://img.alicdn.com/imgextra/i3/O1CN01alqsQS1G2oQecFYIs_!!6000000000565-2-tps-1025-573.png",alt:"image20201205-232516.png"})]}),"\n",(0,s.jsx)(t.p,{children:"\u540e\u7eed\uff0c\u8fd8\u6709\u8bb8\u591a\u5de5\u4f5c\u53ef\u4ee5\u505a\uff0c\u6bd4\u5982\uff1a\u5bf9\u6ce8\u518c\u4e2d\u5fc3\u7684\u652f\u6301\u3001\u5bf9\u914d\u7f6e\u4e2d\u5fc3\u7684\u652f\u6301\u3001\u548c java \u7248 seata 1.4 \u7684\u534f\u8bae\u4e92\u901a\u3001\u5176\u4ed6\u6570\u636e\u5e93\u7684\u652f\u6301\u3001raft transaction coordinator \u7684\u5b9e\u73b0\u7b49\uff0c\u5e0c\u671b\u5bf9\u5206\u5e03\u5f0f\u4e8b\u52a1\u95ee\u9898\u611f\u5174\u8da3\u7684\u5f00\u53d1\u8005\u53ef\u4ee5\u52a0\u5165\u8fdb\u6765\u4e00\u8d77\u6765\u6253\u9020\u4e00\u4e2a\u5b8c\u5584\u7684 golang \u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u6846\u67b6\u3002"}),"\n",(0,s.jsx)(t.p,{children:"\u5982\u679c\u4f60\u6709\u4efb\u4f55\u7591\u95ee\uff0c\u6b22\u8fce\u9489\u9489\u626b\u7801\u52a0\u5165\u4ea4\u6d41\u7fa4\u3010\u9489\u9489\u7fa4\u53f7 33069364\u3011\uff1a"}),"\n",(0,s.jsx)("img",{src:"https://img.alicdn.com/imgextra/i2/O1CN01IjOVG425erjuzqcOi_!!6000000007552-2-tps-600-621.png",width:"200px"}),"\n",(0,s.jsx)(t.h3,{id:"\u4f5c\u8005\u7b80\u4ecb",children:(0,s.jsx)(t.strong,{children:"\u4f5c\u8005\u7b80\u4ecb"})}),"\n",(0,s.jsx)(t.p,{children:"\u5218\u6653\u654f (GitHubID dk-lockdown)\uff0c\u76ee\u524d\u5c31\u804c\u4e8e h3c \u6210\u90fd\u5206\u516c\u53f8\uff0c\u64c5\u957f\u4f7f\u7528 Java/Go \u8bed\u8a00\uff0c\u5728\u4e91\u539f\u751f\u548c\u5fae\u670d\u52a1\u76f8\u5173\u6280\u672f\u65b9\u5411\u5747\u6709\u6d89\u730e\uff0c\u76ee\u524d\u4e13\u653b\u5206\u5e03\u5f0f\u4e8b\u52a1\u3002\n\u4e8e\u96e8(github @AlexStocks)\uff0cdubbo-go \u9879\u76ee\u548c\u793e\u533a\u8d1f\u8d23\u4eba\uff0c\u4e00\u4e2a\u6709\u5341\u591a\u5e74\u670d\u52a1\u7aef\u57fa\u7840\u67b6\u6784\u7814\u53d1\u4e00\u7ebf\u5de5\u4f5c\u7ecf\u9a8c\u7684\u7a0b\u5e8f\u5458\uff0c\u9646\u7eed\u53c2\u4e0e\u6539\u8fdb\u8fc7 Muduo/Pika/Dubbo/Sentinel-go \u7b49\u77e5\u540d\u9879\u76ee\uff0c\u76ee\u524d\u5728\u8682\u8681\u91d1\u670d\u53ef\u4fe1\u539f\u751f\u90e8\u4ece\u4e8b\u5bb9\u5668\u7f16\u6392\u548c service mesh \u5de5\u4f5c\u3002"}),"\n",(0,s.jsx)(t.h4,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,s.jsxs)(t.p,{children:["seata \u5b98\u65b9\uff1a",(0,s.jsx)(t.a,{href:"https://seata.apache.org",children:"https://seata.apache.org"})]}),"\n",(0,s.jsxs)(t.p,{children:["java \u7248 seata\uff1a",(0,s.jsx)(t.a,{href:"https://github.com/apache/incubator-seata",children:"https://github.com/apache/incubator-seata"})]}),"\n",(0,s.jsxs)(t.p,{children:["seata-golang \u9879\u76ee\u5730\u5740\uff1a",(0,s.jsx)(t.a,{href:"https://github.com/apache/incubator-seata-go",children:"https://github.com/apache/incubator-seata-go"})]}),"\n",(0,s.jsxs)(t.p,{children:["seata-golang go \u591c\u8bfb b\u7ad9\u5206\u4eab\uff1a",(0,s.jsx)(t.a,{href:"https://www.bilibili.com/video/BV1oz411e72T",children:"https://www.bilibili.com/video/BV1oz411e72T"})]})]})}function g(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>i});var s=n(96540);const o={},r=s.createContext(o);function a(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);