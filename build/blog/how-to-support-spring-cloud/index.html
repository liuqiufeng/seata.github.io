<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Fescar Integration with Spring Cloud In-Depth Analysis of Source Code | Apache Seata</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://seata.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://seata.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://seata.apache.org/blog/how-to-support-spring-cloud"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Fescar Integration with Spring Cloud In-Depth Analysis of Source Code | Apache Seata"><meta data-rh="true" name="description" content="Fescar"><meta data-rh="true" property="og:description" content="Fescar"><meta data-rh="true" name="keywords" content="fescar,seata,Distributed,transaction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-04-15T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/seata_logo_small.jpeg"><link data-rh="true" rel="canonical" href="https://seata.apache.org/blog/how-to-support-spring-cloud"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/how-to-support-spring-cloud" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://seata.apache.org/zh-cn/blog/how-to-support-spring-cloud" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seata.apache.org/blog/how-to-support-spring-cloud" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ICHFIJRDZF-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Seata RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Seata Atom Feed">


<link rel="search" type="application/opensearchdescription+xml" title="Apache Seata" href="/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=seata">
<script src="https://www.googletagmanager.com/gtag/js?id=G-X4LJGF90X2" async></script><link rel="stylesheet" href="/assets/css/styles.5eb339aa.css">
<link rel="preload" href="/assets/js/runtime~main.715960d6.js" as="script">
<link rel="preload" href="/assets/js/main.3f223ee1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="https://hm.baidu.com/hm.js?104e73ef0c18b416b27abb23757ed8ee"></script>
<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/seata_logo.png" alt="Seata Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/overview/what-is-seata" href="/docs/overview/what-is-seata">v2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/overview/what-is-seata">Next Version</a></li><li><a class="dropdown__link" href="/docs/overview/what-is-seata">v2.0</a></li><li><a class="dropdown__link" href="/docs/v1.8/overview/what-is-seata">v1.8</a></li><li><a class="dropdown__link" href="/docs/v1.7/overview/what-is-seata">v1.7</a></li><li><a class="dropdown__link" href="/docs/v1.6/overview/what-is-seata">v1.6</a></li><li><a class="dropdown__link" href="/docs/v1.5/overview/what-is-seata">v1.5</a></li><li><a class="dropdown__link" href="/docs/v1.4/overview/what-is-seata">v1.4</a></li><li><a class="dropdown__link" href="/docs/v1.3/overview/what-is-seata">v1.3</a></li><li><a class="dropdown__link" href="/docs/v1.2/overview/what-is-seata">v1.2</a></li><li><a class="dropdown__link" href="/docs/v1.1/overview/what-is-seata">v1.1</a></li><li><a class="dropdown__link" href="/docs/v1.0/overview/what-is-seata">v1.0</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/developers/contributor-guide/new-contributor-guide_dev">Developers</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/unversioned/download/seata-server">Download</a><a class="navbar__item navbar__link" href="/solution">Solution</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Demos</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_blank" href="/saga-designer">Saga Designer</a></li><li><a class="dropdown__link" target="_blank" href="/saga-designer-legacy">Saga Designer (Legacy)</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/blog/how-to-support-spring-cloud" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/blog/how-to-support-spring-cloud" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">ä¸­</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-with-spring-cloud">integrate-seata-with-spring-cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/iscas2023">iscas2023</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.5.2">seata-1.5.2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-1.6.0">seata-1.6.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-config-modular">seata-analysis-config-modular</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-core-modular">seata-analysis-core-modular</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-dubbo-transmit-xid">seata-analysis-dubbo-transmit-xid</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-go-server">seata-analysis-go-server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-client">seata-analysis-java-client</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-java-server">seata-analysis-java-server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-simple">seata-analysis-simple</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-tcc-modular">seata-analysis-tcc-modular</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-demo-in-mac">seata-at-demo-in-mac</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-lock">seata-at-lock</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-design">seata-at-mode-design</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start-rm-tm">seata-at-mode-start-rm-tm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-mode-start">seata-at-mode-start</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-at-tcc-saga">seata-at-tcc-saga</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-01">seata-client-start-analysis-01</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-client-start-analysis-02">seata-client-start-analysis-02</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-community-meetup-hangzhou-ready">seata-community-meetup-hangzhou-ready</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-center">seata-config-center</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-config-manager">seata-config-manager</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-datasource-proxy">seata-datasource-proxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dsproxy-deadlock">seata-dsproxy-deadlock</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-dynamic-config-and-dynamic-disable">seata-dynamic-config-and-dynamic-disable</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-go-1.2.0">seata-go-1.2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-golang-communication-mode">seata-golang-communication-mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-ha-practice">seata-ha-practice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-meetup-hangzhou">seata-meetup-hangzhou</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-mybatisplus-analysis">seata-mybatisplus-analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-analysis">seata-nacos-analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-nacos-docker">seata-nacos-docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-observable-practice">seata-observable-practice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-quick-start">seata-quick-start</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-raft-detailed-explanation">seata-raft-detailed-explanation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-rpc-refactor">seata-rpc-refactor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-client-bootstrap">seata-sourcecode-client-bootstrap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-sourcecode-server-bootstrap">seata-sourcecode-server-bootstrap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-spring-boot-aop-aspectj">seata-spring-boot-aop-aspectj</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc">seata-tcc</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-xa-introduce">seata-xa-introduce</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/springboot-dubbo-mybatisplus-seata">springboot-dubbo-mybatisplus-seata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-applicable-scenario-analysis">tcc-mode-applicable-scenario-analysis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tcc-mode-design-principle">tcc-mode-design-principle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/explore-seata-journey">Exploring the Journey of Open Source Development in Seata Project</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-connect-data-and-application">Seata:Bridging Data and Applications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-tcc-fence">Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-snowflake-explain">Q&amp;A on the New Version of Snowflake Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-analysis-UUID-generator">Analysis of Seata&#x27;s Distributed UUID Generator Based on Improved Snowflake Algorithm</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/seata-feature-undo-log-compress">Seata New Feature Support -- Undo_Log Compression</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/integrate-seata-tcc-mode-with-spring-cloud">Integration of Spring Cloud with Seata for Distributed Transaction - TCC Mode</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/design-more-flexable-application-by-saga">Designing More Flexible Financial Applications with Seata Saga</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/how-to-support-spring-cloud">Fescar Integration with Spring Cloud In-Depth Analysis of Source Code</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quick-start-use-seata-and-dubbo-services">How to use Seata to ensure consistency between Dubbo Microservices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/manual-transaction-mode">MT mode</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Fescar Integration with Spring Cloud In-Depth Analysis of Source Code</h1><div class="container_mt6G margin-vert--md"><time datetime="2019-04-15T00:00:00.000Z" itemprop="datePublished">April 15, 2019</time> Â· <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">shukang.guo min.ji</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar">Fescar<a href="#fescar" class="hash-link" aria-label="Direct link to Fescar" title="Direct link to Fescar">â</a></h3><p>Common distributed transaction approaches include XA based on 2PC (e.g., Atomikos), TCC (e.g., ByteTCC) focusing on the business layer, and transactional messaging (e.g., RocketMQ Half Message). XA is a protocol for distributed transactions that requires support from local databases. However, the resource locking at the database level can lead to poor performance. On the other hand, TCC, introduced by Alibaba as a preacher, requires a significant amount of business code to ensure transactional consistency, resulting in higher development and maintenance costs.</p><p>Distributed transactions are a widely discussed topic in the industry, and this is one of the reasons why Fescar has gained 6k stars in a short period of time. The name &quot;Fescar&quot; stands for Fast &amp; Easy Commit And Rollback. In simple terms, Fescar drives global transactions by coordinating local RDBMS branch transactions. It is a middleware that operates at the application layer. The main advantages of Fescar are better performance compared to XA, as it does not occupy connection resources for a long time, and lower development cost and business invasiveness compared to TCC.</p><p>Similar to XA, Fescar divides roles into TC (Transaction Coordinator), RM (Resource Manager), and TM (Transaction Manager). The overall transaction process model of Fescar is as follows:</p><p><img loading="lazy" alt="Fescaräºå¡è¿ç¨" src="/assets/images/fescar-microservices-88885eb3928c478894342041e066a5ce.png" width="794" height="478" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.The TM (Transaction Manager) requests the TC (Transaction Coordinator) to start a global transaction. The global transaction is successfully created, and a globally unique XID (Transaction ID) is generated.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.The XID is propagated in the context of the microservice invocation chain.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3.The RM (Resource Manager) registers the branch transaction with the TC, bringing it under the jurisdiction of the global transaction corresponding to the XID.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4.The TM initiates a global commit or rollback resolution for the XID with the TC.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5.The TC schedules the completion of commit or rollback requests for all branch transactions under the jurisdiction of the XID.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the current implementation version, the TC (Transaction Coordinator) is deployed as a separate process. It is responsible for maintaining the operation records and global lock records of the global transaction, as well as coordinating and driving the global transaction&#x27;s commit or rollback. On the other hand, the TM (Transaction Manager) and RM (Resource Manager) work in the same application process as the application.</p><p>The RM manages the underlying database through proxying the JDBC data source. It uses syntax parsing to retain snapshots and generate undo logs during transaction execution. This ensures that the transaction can be rolled back to its previous state if needed.</p><p>This covers the general flow and model division of Fescar. Now, let&#x27;s proceed with the analysis of Fescar&#x27;s transaction propagation mechanism.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-transaction-propagation-mechanism">Fescar Transaction Propagation Mechanism<a href="#fescar-transaction-propagation-mechanism" class="hash-link" aria-label="Direct link to Fescar Transaction Propagation Mechanism" title="Direct link to Fescar Transaction Propagation Mechanism">â</a></h3><p>The transaction propagation in Fescar includes both nested transaction calls within an application and transaction propagation across different services. So, how does Fescar propagate transactions in a microservices call chain? Fescar provides a transaction API that allows users to manually bind a transaction&#x27;s XID and join it to the global transaction. Therefore, depending on the specific service framework mechanism, we can propagate the XID in the call chain to achieve transaction propagation.</p><p>The RPC request process consists of two parts: the caller and the callee. We need to handle the XID during the request and response. The general process is as follows: the caller (or the requester) retrieves the XID from the current transaction context and passes it to the callee through the RPC protocol. The callee extracts the XID from the request and binds it to its own transaction context, thereby participating in the global transaction. Common microservices frameworks usually provide corresponding Filter and Interceptor mechanisms. Now, let&#x27;s analyze the integration process of Spring Cloud and Fescar in more detail.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="partial-source-code-analysis-of-fescar-integration-with-spring-cloud-alibaba">Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba<a href="#partial-source-code-analysis-of-fescar-integration-with-spring-cloud-alibaba" class="hash-link" aria-label="Direct link to Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba" title="Direct link to Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba">â</a></h3><p>This section of the source code is entirely from spring-cloud-alibaba-fescar. The source code analysis mainly includes three parts: AutoConfiguration, the microservice provider, and the microservice consumer. Regarding the microservice consumer, it can be further divided into two specific approaches: RestTemplate and Feign. For the Feign request approach, it is further categorized into usage patterns that integrate with Hystrix and Sentine.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-autoconfiguration">Fescar AutoConfiguration<a href="#fescar-autoconfiguration" class="hash-link" aria-label="Direct link to Fescar AutoConfiguration" title="Direct link to Fescar AutoConfiguration">â</a></h4><p>For the AutoConfiguration analysis, this section will only cover the parts related to the startup of Fescar. The analysis of other parts will be interspersed in the &#x27;Microservice Provider&#x27; and &#x27;Microservice Consumer&#x27; sections.</p><p>The startup of Fescar requires the configuration of GlobalTransactionScanner. The GlobalTransactionScanner is responsible for initializing Fescar&#x27;s RM client, TM client, and automatically proxying classes annotated with the GlobalTransactional annotation. The startup of the GlobalTransactionScanner bean is loaded and injected through GlobalTransactionAutoConfiguration, which also injects FescarProperties.</p><p>FescarProperties contains important properties of Fescar, such as txServiceGroup. The value of this property can be read from the application.properties file using the key &#x27;spring.cloud.alibaba.fescar.txServiceGroup&#x27;, with a default value of &#x27;${spring.application.name}-fescar-service-group&#x27;. txServiceGroup represents the logical transaction group name in Fescar. This group name is obtained from the configuration center (currently supporting file and Apollo) to retrieve the TC cluster name corresponding to the logical transaction group name. The TC cluster&#x27;s service name is then constructed based on the cluster name. The RM client, TM client, and TC interact through RPC by using the registry center (currently supporting Nacos, Redis, ZooKeeper, and Eureka) and the service name to find available TC service nodes.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="microservice-provider">Microservice Provider<a href="#microservice-provider" class="hash-link" aria-label="Direct link to Microservice Provider" title="Direct link to Microservice Provider">â</a></h4><p>Since the logic of the consumer is a bit more complex, let&#x27;s first analyze the logic of the provider. For Spring Cloud projects, the default RPC transport protocol is HTTP, so the HandlerInterceptor mechanism is used to intercept HTTP requests.</p><p>HandlerInterceptor is an interface provided by Spring, and it has three methods that can be overridden.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerMapping determined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * an appropriate handler object, but before HandlerAdapter invokes the handler.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerAdapter actually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * invoked the handler, but before the DispatcherServlet renders the view.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Can expose additional model objects to the view via the given ModelAndView.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable ModelAndView modelAndView) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback after completion of request processing, that is, after rendering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the view. Will be called on any outcome of handler execution, thus allows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * for proper resource cleanup.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable Exception ex) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>According to the comments, we can clearly see the timing and common use cases of each method. For Fescar integration, it overrides the preHandle and afterCompletion methods as needed.</p><p>The purpose of FescarHandlerInterceptor is to bind the XID passed from the service chain to the transaction context of the service node and clean up related resources after the request is completed. FescarHandlerInterceptorConfiguration is responsible for configuring the interception of all URLs. This interceptor will be executed for all incoming requests to perform XID conversion and transaction binding.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author xiaojing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Fescar HandlerInterceptor, Convert Fescar information into</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @see com.alibaba.fescar.core.context.RootContext from http request&#x27;s header in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#preHandle(HttpServletRequest , HttpServletResponse , Object )},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * And clean up Fescar information after servlet method invocation in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#afterCompletion(HttpServletRequest, HttpServletResponse, Object, Exception)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHandlerInterceptor implements HandlerInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger log = LoggerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .getLogger(FescarHandlerInterceptor.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;xid in RootContext {} xid in RpcContext {}&quot;, xid, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid == null &amp;&amp; rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.debug(&quot;bind {} to RootContext&quot;, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler, Exception e) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(rpcXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;unbind {} from RootContext&quot;, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;xid in change during RPC from {} to {}&quot;, rpcXid, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;bind {} back to RootContext&quot;, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The preHandle method is called before the request is executed. The xid parameter represents the unique identifier of the global transaction already bound to the current transaction context, while rpcXid represents the global transaction identifier that needs to be bound to the request and is passed through the HTTP header. In the preHandle method, it checks if there is no XID in the current transaction context and if rpcXid is not empty. If so, it binds rpcXid to the current transaction context.</p><p>The afterCompletion method is called after the request is completed and is used to perform resource cleanup actions. Fescar uses the RootContext.unbind() method to unbind the XID involved in the transaction context. The logic in the if statement is for code robustness. If rpcXid and unbindXid are not equal, it rebinds unbindXid.</p><p>For Spring Cloud, the default RPC method is HTTP. Therefore, for the provider, there is no need to differentiate the request interception method. It only needs to extract the XID from the header and bind it to its own transaction context. However, for the consumer, due to the variety of request components, including circuit breakers and isolation mechanisms, different situations need to be distinguished and handled. We will analyze this in more detail later.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="microservice-consumer">Microservice Consumer<a href="#microservice-consumer" class="hash-link" aria-label="Direct link to Microservice Consumer" title="Direct link to Microservice Consumer">â</a></h4><p>Fescar categorizes the request methods into RestTemplate, Feign, Feign+Hystrix, and Feign+Sentinel. Different components are automatically configured through Spring Boot&#x27;s Auto Configuration. The specific configuration classes can be found in the spring.factories file, and we will also discuss the relevant configuration classes later in this document.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="resttemplate">RestTemplate<a href="#resttemplate" class="hash-link" aria-label="Direct link to RestTemplate" title="Direct link to RestTemplate">â</a></h5><p>Let&#x27;s take a look at how Fescar passes XID if the consumer is using RestTemplate for requests.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateInterceptor implements ClientHttpRequestInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ClientHttpResponse intercept(HttpRequest httpRequest, byte[] bytes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientHttpRequestExecution clientHttpRequestExecution) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpRequestWrapper requestWrapper = new HttpRequestWrapper(httpRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestWrapper.getHeaders().add(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return clientHttpRequestExecution.execute(requestWrapper, bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The FescarRestTemplateInterceptor implements the intercept method of the ClientHttpRequestInterceptor interface. It wraps the outgoing request and, if there is an existing Fescar transaction context XID, retrieves it and adds it to the HTTP headers of the request.</p><p>FescarRestTemplateInterceptor is configured in RestTemplate through FescarRestTemplateAutoConfiguration.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarRestTemplateInterceptor fescarRestTemplateInterceptor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarRestTemplateInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Collection&lt;RestTemplate&gt; restTemplates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private FescarRestTemplateInterceptor fescarRestTemplateInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.restTemplates != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (RestTemplate restTemplate : restTemplates) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;ClientHttpRequestInterceptor&gt; interceptors = new ArrayList&lt;ClientHttpRequestInterceptor&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        restTemplate.getInterceptors());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                interceptors.add(this.fescarRestTemplateInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                restTemplate.setInterceptors(interceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The init method iterates through all the RestTemplate instances, retrieves the original interceptors from each RestTemplate, adds the fescarRestTemplateInterceptor, and then reorders the interceptors.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="feign">Feign<a href="#feign" class="hash-link" aria-label="Direct link to Feign" title="Direct link to Feign">â</a></h5><p><img loading="lazy" alt="Feign ç±»å³ç³»å¾" src="/assets/images/20190305184812-46ab74f3830c4789b6f410150de067d6.png" width="1986" height="788" class="img_ev3q"></p><p>Next, let&#x27;s take a look at the code related to Feign. There are quite a few classes in this package, so let&#x27;s start with its AutoConfiguration.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(Client.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureBefore(FeignAutoConfiguration.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClientAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = &quot;com.netflix.hystrix.HystrixCommand&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;feign.hystrix.enabled&quot;, havingValue = &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignHystrixBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarHystrixFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = &quot;com.alibaba.csp.sentinel.SphU&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;feign.sentinel.enabled&quot;, havingValue = &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignSentinelBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarSentinelFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope(&quot;prototype&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static class FeignBeanPostProcessorConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarBeanPostProcessor fescarBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                FescarFeignObjectWrapper fescarFeignObjectWrapper) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarBeanPostProcessor(fescarFeignObjectWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextBeanPostProcessor fescarContextBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarContextBeanPostProcessor(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarFeignObjectWrapper fescarFeignObjectWrapper(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignObjectWrapper(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The FescarFeignClientAutoConfiguration is enabled when the Client.class exists and requires it to be applied before FeignAutoConfiguration. Since FeignClientsConfiguration is responsible for generating the FeignContext and is enabled by FeignAutoConfiguration, based on the dependency relationship, FescarFeignClientAutoConfiguration is also applied before FeignClientsConfiguration.</p><p>FescarFeignClientAutoConfiguration customizes the Feign.Builder and adapts it for feign.sentinel, feign.hystrix, and regular feign cases. The purpose is to customize the actual implementation of the Client in Feign to be FescarFeignClient.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HystrixFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .client(new FescarFeignClient(beanFactory))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SentinelFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Feign.builder().client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarFeignClient is an enhancement of the original Feign client proxy.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClient implements Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Client delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = new Client.Default(null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory, Client delegate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Response execute(Request request, Request.Options options) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Request modifiedRequest = getModifyRequest(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.delegate.execute(modifiedRequest, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Request getModifyRequest(Request request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Collection&lt;String&gt;&gt; headers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.putAll(request.headers());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; fescarXid = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fescarXid.add(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.put(RootContext.KEY_XID, fescarXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Request.create(request.method(), request.url(), headers, request.body(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                request.charset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above process, we can see that FescarFeignClient modifies the original Request. It first retrieves the XID from the current transaction context and, if the XID is not empty, adds it to the request&#x27;s header.</p><p>FeignBeanPostProcessorConfiguration defines three beans: FescarContextBeanPostProcessor, FescarBeanPostProcessor, and FescarFeignObjectWrapper. FescarContextBeanPostProcessor and FescarBeanPostProcessor both implement the Spring BeanPostProcessor interface.</p><p>Here is the implementation of FescarContextBeanPostProcessor</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessBeforeInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof FeignContext &amp;&amp; !(bean instanceof FescarFeignContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignContext(getFescarFeignObjectWrapper(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (FeignContext) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The two methods in BeanPostProcessor allow for pre- and post-processing of beans in the Spring container. The postProcessBeforeInitialization method is called before initialization, while the postProcessAfterInitialization method is called after initialization. The return value of these methods can be the original bean instance or a wrapped instance using a wrapper.</p><p>FescarContextBeanPostProcessor wraps FeignContext into FescarFeignContext. FescarBeanPostProcessor wraps FeignClient into FescarLoadBalancerFeignClient and FescarFeignClient, depending on whether it inherits from LoadBalancerFeignClient.</p><p>In FeignAutoConfiguration, the FeignContext does not have any ConditionalOnXXX conditions. Therefore, Fescar uses a pre-processing approach to wrap FeignContext into FescarFeignContext.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FeignContext feignContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = new FeignContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setConfigurations(this.configurations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For Feign Clients, the FeignClientFactoryBean retrieves an instance of FeignContext. For custom Feign Client objects configured by developers using the @Configuration annotation, they are configured into the builder, which causes the enhanced FescarFeignClient in FescarFeignBuilder to become ineffective. The key code in FeignClientFactoryBean is as follows</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the target type of the Feign client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return a {@link Feign} client created with the specified data and the context information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getTarget() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = applicationContext.getBean(FeignContext.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Feign.Builder builder = feign(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasText(this.url)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.name.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = &quot;http://&quot; + this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            url += cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (T) loadBalance(builder, context, new HardCodedTarget&lt;&gt;(this.type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.url = &quot;http://&quot; + this.url;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = this.url + cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Client client = getOptional(context, Client.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (client != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (client instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // not load balancing because we have a url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // but ribbon is on the classpath, so unwrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                client = ((LoadBalancerFeignClient)client).getDelegate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.client(client);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Targeter targeter = get(context, Targeter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (T) targeter.target(this, builder, context, new HardCodedTarget&lt;&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.type, this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above code determines whether to make a direct call to the specified URL or use load balancing based on whether the URL parameter is specified in the annotation. The targeter.target method creates the object through dynamic proxy. The general process is as follows: the parsed Feign methods are stored in a map, and then passed as a parameter to generate the InvocationHandler, which in turn generates the dynamic proxy object.</p><p>The presence of FescarContextBeanPostProcessor ensures that even if developers customize operations on FeignClient, the enhancement of global transactions required by Fescar can still be achieved.</p><p>As for FescarFeignObjectWrapper, let&#x27;s focus on the Wrapper method:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Object wrap(Object bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof Client &amp;&amp; !(bean instanceof FescarFeignClient)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bean instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LoadBalancerFeignClient client = ((LoadBalancerFeignClient) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new FescarLoadBalancerFeignClient(client.getDelegate(), factory(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        clientFactory(), this.beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignClient(this.beanFactory, (Client) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the wrap method, if the bean is an instance of LoadBalancerFeignClient, it first retrieves the actual Client object that the LoadBalancerFeignClient proxies using the client.getDelegate() method. It then wraps the Client object into FescarFeignClient and generates a subclass of LoadBalancerFeignClient called FescarLoadBalancerFeignClient. If the bean is an instance of Client and not FescarFeignClient or LoadBalancerFeignClient, it is directly wrapped and transformed into FescarFeignClient.</p><p>The above process design is quite clever. It controls the order of configuration based on Spring Boot&#x27;s Auto Configuration and customizes the Feign Builder bean to ensure that all Clients are enhanced with FescarFeignClient. It also wraps the beans in the Spring container using BeanPostProcessor, ensuring that all beans in the container are enhanced with FescarFeignClient, thus avoiding the replacement action in the getTarget method of FeignClientFactoryBean.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix-isolation">Hystrix Isolation<a href="#hystrix-isolation" class="hash-link" aria-label="Direct link to Hystrix Isolation" title="Direct link to Hystrix Isolation">â</a></h5><p>Now let&#x27;s take a look at the Hystrix part. Why do we separate Hystrix and implement a separate strategy class in Fescar? Currently, the default implementation of the transaction context RootContext is based on ThreadLocal, which means the context is bound to the thread. Hystrix itself has two isolation modes: semaphore-based isolation and thread pool-based isolation. Hystrix officially recommends using thread pool isolation for better separation, which is the commonly used mode:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread or Semaphore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The default, and the recommended setting, is to run HystrixCommands using thread isolation (THREAD) and HystrixObservableCommands using semaphore isolation (SEMAPHORE).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Commands executed in threads have an extra layer of protection against latencies beyond what network timeouts can offer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Generally the only time you should use semaphore isolation for HystrixCommands is when the call is so high volume (hundreds per second, per instance) that the overhead of separate threads is too high; this typically only applies to non-network calls.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You are correct that the service layer&#x27;s business code and the thread that sends the request are not the same. Therefore, the ThreadLocal approach cannot pass the XID to the Hystrix thread and subsequently to the callee. To address this issue, Hystrix provides a mechanism for developers to customize the concurrency strategy. This can be done by extending the HystrixConcurrencyStrategy class and overriding the wrapCallable method:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixConcurrencyStrategy extends HystrixConcurrencyStrategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HystrixConcurrencyStrategy delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.getInstance().registerConcurrencyStrategy(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;K&gt; Callable&lt;K&gt; wrapCallable(Callable&lt;K&gt; c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (c instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Callable&lt;K&gt; wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.delegate != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = this.delegate.wrapCallable(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (wrappedCallable instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarContextCallable&lt;&gt;(wrappedCallable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class FescarContextCallable&lt;K&gt; implements Callable&lt;K&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Callable&lt;K&gt; actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final String xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextCallable(Callable&lt;K&gt; actual) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.actual = actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public K call() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return actual.call();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fescar also provides a FescarHystrixAutoConfiguration, which generates the FescarHystrixConcurrencyStrategy when HystrixCommand is present.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HystrixCommand.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarHystrixConcurrencyStrategy fescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarHystrixConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reference">reference<a href="#reference" class="hash-link" aria-label="Direct link to reference" title="Direct link to reference">â</a></h3><ul><li><p>Fescar: <a href="https://github.com/alibaba/fescar" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/fescar</a></p></li><li><p>Spring Cloud Alibaba: <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud-incubator/spring-cloud-alibaba</a></p></li><li><p>spring-cloud-openfeign: <a href="https://github.com/spring-cloud/spring-cloud-openfeign" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud/spring-cloud-openfeign</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="author">author<a href="#author" class="hash-link" aria-label="Direct link to author" title="Direct link to author">â</a></h3><p> kangshu.guoï¼Community nickname ywind, formerly employed at Huawei Terminal Cloud, currently a Java engineer at Sohu Intelligent Media Center. Mainly responsible for development related to Sohu accounts. Has a strong interest in distributed transactions, distributed systems, and microservices architecture.
min.ji(qinming)ï¼Community nickname slievrly, Fescar project leader, core developer of Alibaba middleware TXC/GTS. Engaged in core research and development work in distributed middleware for a long time. Has extensive technical expertise in the field of distributed transactions.</p></li></ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/how-to-support-spring-cloud.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/design-more-flexable-application-by-saga"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Designing More Flexible Financial Applications with Seata Saga</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/quick-start-use-seata-and-dubbo-services"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">How to use Seata to ensure consistency between Dubbo Microservices</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fescar" class="table-of-contents__link toc-highlight">Fescar</a></li><li><a href="#fescar-transaction-propagation-mechanism" class="table-of-contents__link toc-highlight">Fescar Transaction Propagation Mechanism</a></li><li><a href="#partial-source-code-analysis-of-fescar-integration-with-spring-cloud-alibaba" class="table-of-contents__link toc-highlight">Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">reference</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/apache/incubator.svg" alt="Apache Incubator Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">
                  <div class="fs-12">
                    <div class="center-div">
                      <span>Apache Seata (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</span>
                    </div>
                    <br>
                    <div class="center-div">
                      <span>Copyright Â© 2023-2024, The Apache Software Foundation Apache Seata, Seata, Apache, Apache Incubator, the Apache feather, the Apache Incubator logo and the Apache Seata project logo are either registered trademarks or trademarks of the Apache Software Foundation.</span>
                      <br>
                    </div>
                    <br>
                  </div>
                  </div></div></div></footer></div>
<script src="/assets/js/runtime~main.715960d6.js"></script>
<script src="/assets/js/main.3f223ee1.js"></script>
</body>
</html>