"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[6446],{58421:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var o=t(74848),i=t(28453);const r={title:"Source Code Analysis of Seata-XID Propagation in Dubbo",keywords:["Seata","Dubbo","distributed transaction","spring"],description:"This article explores the propagation of XID in Seata-Dubbo through source code analysis.",author:"FUNKYE",date:"2020/01/01"},a="Seata-XID Transmission Source Code Analysis: Dubbo Edition",s={permalink:"/seata.github.io/blog/seata-analysis-dubbo-transmit-xid",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/seata-analysis-dubbo-transmit-xid.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/seata-analysis-dubbo-transmit-xid.md",title:"Source Code Analysis of Seata-XID Propagation in Dubbo",description:"This article explores the propagation of XID in Seata-Dubbo through source code analysis.",date:"2020-01-01T00:00:00.000Z",formattedDate:"January 1, 2020",tags:[],readingTime:2.225,hasTruncateMarker:!1,authors:[{name:"FUNKYE"}],frontMatter:{title:"Source Code Analysis of Seata-XID Propagation in Dubbo",keywords:["Seata","Dubbo","distributed transaction","spring"],description:"This article explores the propagation of XID in Seata-Dubbo through source code analysis.",author:"FUNKYE",date:"2020/01/01"},unlisted:!1,prevItem:{title:"Seata Config Module Source Code Analysis",permalink:"/seata.github.io/blog/seata-analysis-config-modular"},nextItem:{title:"Seata TCC Module Source Code Analysis",permalink:"/seata.github.io/blog/seata-analysis-tcc-modular"}},c={authorsImageUrls:[void 0]},d=[{value:"Source Code Analysis",id:"source-code-analysis",level:2},{value:"Key Points",id:"key-points",level:2}];function p(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.p,{children:"Author: FUNKYE (Chen Jianbin), Principal Engineer at a certain Internet company in Hangzhou."}),"\n",(0,o.jsx)(e.h1,{id:"preface",children:"Preface"}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"Let's start by examining the package structure. Under seata-dubbo and seata-dubbo-alibaba, there is a common class named TransactionPropagationFilter, corresponding to Apache Dubbo and Alibaba Dubbo respectively."}),"\n"]}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"20200101203229",src:t(11844).A+"",width:"422",height:"410"})}),"\n",(0,o.jsx)(e.h2,{id:"source-code-analysis",children:"Source Code Analysis"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-java",children:'package io.seata.integration.dubbo;\n\nimport io.seata.core.context.RootContext;\nimport org.apache.dubbo.common.Constants;\nimport org.apache.dubbo.common.extension.Activate;\nimport org.apache.dubbo.rpc.Filter;\nimport org.apache.dubbo.rpc.Invocation;\nimport org.apache.dubbo.rpc.Invoker;\nimport org.apache.dubbo.rpc.Result;\nimport org.apache.dubbo.rpc.RpcContext;\nimport org.apache.dubbo.rpc.RpcException;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n@Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100)\npublic class TransactionPropagationFilter implements Filter {\n\n    private static final Logger LOGGER = LoggerFactory.getLogger(TransactionPropagationFilter.class);\n\n    @Override\n    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n        // get local XID\n        String xid = RootContext.getXID();\n        String xidInterceptorType = RootContext.getXIDInterceptorType();\n        // get XID from dubbo param\n        String rpcXid = getRpcXid();\n        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("xid in RootContext[{}] xid in RpcContext[{}]", xid, rpcXid);\n        }\n        boolean bind = false;\n        if (xid != null) {\n            //transfer xid\n            RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n        } else {\n            if (rpcXid != null) {\n                //bind XID\n                RootContext.bind(rpcXid);\n                RootContext.bindInterceptorType(rpcXidInterceptorType);\n                bind = true;\n                if (LOGGER.isDebugEnabled()) {\n                    LOGGER.debug("bind[{}] interceptorType[{}] to RootContext", rpcXid, rpcXidInterceptorType);\n                }\n            }\n        }\n        try {\n            return invoker.invoke(invocation);\n        } finally {\n            if (bind) {\n                //remove xid which has finished\n                String unbindInterceptorType = RootContext.unbindInterceptorType();\n                String unbindXid = RootContext.unbind();\n                if (LOGGER.isDebugEnabled()) {\n                    LOGGER.debug("unbind[{}] interceptorType[{}] from RootContext", unbindXid, unbindInterceptorType);\n                }\n                // if unbind xid is not current rpc xid\n                if (!rpcXid.equalsIgnoreCase(unbindXid)) {\n                    LOGGER.warn("xid in change during RPC from {} to {}, xidInterceptorType from {} to {} ", rpcXid, unbindXid, rpcXidInterceptorType, unbindInterceptorType);\n                    if (unbindXid != null) {\n                        // bind xid\n                        RootContext.bind(unbindXid);\n                        RootContext.bindInterceptorType(unbindInterceptorType);\n                        LOGGER.warn("bind [{}] interceptorType[{}] back to RootContext", unbindXid, unbindInterceptorType);\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * get rpc xid\n     * @return\n     */\n    private String getRpcXid() {\n        String rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID);\n        if (rpcXid == null) {\n            rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID.toLowerCase());\n        }\n        return rpcXid;\n    }\n\n}\n'})}),"\n",(0,o.jsx)(e.p,{children:"\u200b 1. Based on the source code, we can deduce the corresponding logic processing."}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"20200101213336",src:t(91532).A+"",width:"775",height:"743"})}),"\n",(0,o.jsx)(e.h2,{id:"key-points",children:"Key Points"}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"Dubbo @Activate Annotation:"}),"\n"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-java",children:"@Documented\n@Retention(RetentionPolicy.RUNTIME)\n@Target({ElementType.TYPE, ElementType.METHOD})\npublic @interface Activate {\n\n    String[] group() default {};\n\n\n    String[] value() default {};\n\n\n    String[] before() default {};\n\n\n    String[] after() default {};\n\n\n    int order() default 0;\n}\n"})}),"\n",(0,o.jsx)(e.p,{children:"It can be analyzed that the @Activate annotation on Seata's Dubbo filter, with parameters @Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100), indicates that both the Dubbo service provider and consumer will trigger this filter. Therefore, our Seata initiator will initiate an XID transmission. The above flowchart and code have clearly represented this."}),"\n",(0,o.jsxs)(e.ol,{start:"2",children:["\n",(0,o.jsx)(e.li,{children:"Dubbo implicit parameter passing can be achieved through setAttachment and getAttachment on RpcContext for implicit parameter transmission between service consumers and providers."}),"\n"]}),"\n",(0,o.jsx)(e.p,{children:"Fetching: RpcContext.getContext().getAttachment(RootContext.KEY_XID);"}),"\n",(0,o.jsx)(e.p,{children:"Passing: RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);"}),"\n",(0,o.jsx)(e.h1,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsxs)(e.p,{children:["For further source code reading, please visit the ",(0,o.jsx)(e.a,{href:"https://seata.apache.org/",children:"Seata official website"})]})]})}function l(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(p,{...n})}):p(n)}},11844:(n,e,t)=>{t.d(e,{A:()=>o});const o=t.p+"assets/images/20200101203229-b1377d653c52962ea621a450291bcf87.png"},91532:(n,e,t)=>{t.d(e,{A:()=>o});const o=t.p+"assets/images/20200101213336-dec117cebba3464f980a52714f43ff7d.png"},28453:(n,e,t)=>{t.d(e,{R:()=>a,x:()=>s});var o=t(96540);const i={},r=o.createContext(i);function a(n){const e=o.useContext(r);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:a(n.components),o.createElement(r.Provider,{value:e},n.children)}}}]);